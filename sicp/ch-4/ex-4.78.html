<!doctype html>
<html class="no-js" lang="en">
<head>
	<meta charset="utf-8" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<title>SICP Solutions</title>
	<link rel="stylesheet" href="https://www.inchmeal.io/assets/css/styles_inchmeal.css"/>
	<link rel="alternate" type="application/rss+xml" title="Inchmeal RSS" href="/rss-feed.xml" />

	<script src="https://www.inchmeal.io/assets/js/inchmeal_head.js"></script>

	
	<script type="text/x-mathjax-config">
		MathJax.Hub.Config({
			"HTML-CSS": {
				linebreaks: { automatic: true },
				scale: 82,
				styles: {
					".MathJax_Display": {
						"font-size": "105%" //first scale is applied than this is applied on display only because we are using display selector.
					},
					"p .MathJax": { //For inline
						//"background-color": "#FFFF88",
						//color:   "#CC0000",
					}	
				}
			},
			"displayAlign": "left",
			TeX: { 
				equationNumbers: { 
					autoNumber: "AMS" 
				},
				Macros: {
					Exp: "{\\operatorname{\\mathrm{E}}}",
					Var: "{\\operatorname{\\mathrm{Var}}}",
					Cov: "{\\operatorname{\\mathrm{Cov}}}",
					Abs: ['\\left\\lvert #2 \\right\\rvert_{\\text{#1}}', 2, ""],
					Prn: ['\\left( #2 \\right)_{\\text{#1}}', 2, ""]
				}
			}
		});
	</script>
	
	<script type="text/javascript"
			src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
	</script>
	
	

	<meta name="google-site-verification" content="tCrxTm0EXch-6c8nlJPb_Cq-BOBcK9GR2ZP3I1lfLKs" />
	
	<meta name="description" content="Inchmeal | This page contains solutions for Structure and Interpretation of Computer Programs, SICP"/>

	

	



	
	<link rel="icon" sizes="32x32" href="https://www.inchmeal.io/assets/img/favicon-32x32.png">




	
	<link rel="icon" sizes="192x192" href="https://www.inchmeal.io/assets/img/touch-icon-192x192.png">




	
	<link rel="apple-touch-icon-precomposed" sizes="180x180" href="https://www.inchmeal.io/assets/img/apple-touch-icon-180x180-precomposed.png">




	
	<link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://www.inchmeal.io/assets/img/apple-touch-icon-152x152-precomposed.png">




	
	<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://www.inchmeal.io/assets/img/apple-touch-icon-144x144-precomposed.png">




	
	<link rel="apple-touch-icon-precomposed" sizes="120x120" href="https://www.inchmeal.io/assets/img/apple-touch-icon-120x120-precomposed.png">




	
	<link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://www.inchmeal.io/assets/img/apple-touch-icon-114x114-precomposed.png">




	
	<link rel="apple-touch-icon-precomposed" sizes="76x76" href="https://www.inchmeal.io/assets/img/apple-touch-icon-76x76-precomposed.png">




	
	<link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://www.inchmeal.io/assets/img/apple-touch-icon-72x72-precomposed.png">




	
	<link rel="apple-touch-icon-precomposed" href="https://www.inchmeal.io/assets/img/apple-touch-icon-precomposed.png">	




	
	<meta name="msapplication-TileImage" content="https://www.inchmeal.io/assets/img/msapplication_tileimage.png"/>




	
	<meta name="msapplication-TileColor" content="#fabb00">



	<!-- Facebook Optimization -->
	<meta property="og:locale" content="en_EN" />
	
	<meta property="og:title" content="SICP Solutions" />
	<meta property="og:description" content="Inchmeal | This page contains solutions for Structure and Interpretation of Computer Programs, SICP"/>
	<meta property="og:url" content="https://www.inchmeal.io//sicp/ch-4/ex-4.78.html" />
	<meta property="og:site_name" content="inchmeal" />
	

	

	<!-- Search Engine Optimization -->
	

	<link type="text/plain" rel="author" href="https://www.inchmeal.io//humans.txt" />

	
</head>

<body id="top-of-page" class="">
	
<div id="navigation" class="sticky">
  <nav class="top-bar" data-topbar>
    <ul class="title-area">
      <li class="name">
        <h1>
          <a href="https://www.inchmeal.io">
            <img src="https://www.inchmeal.io/assets/img/logo.png"/>
          </a>
        </h1>
      </li>
       <!-- Remove the class "menu-icon" to get rid of menu icon. Take out "Menu"(text inside span) to just have icon alone -->
      <li class="toggle-topbar menu-icon"><a href="#"><span></span></a></li>
    </ul>
    <section class="top-bar-section">

      <ul class="right">
        

              

          
          
              <li class="divider"></li>
              <li><a href="https://www.inchmeal.io/">home</a></li>
          
        

              

          
          
              <li class="divider"></li>
              <li><a href="https://www.inchmeal.io/archives/">archives</a></li>
          
        

              

          
          
              <li class="divider"></li>
              <li><a href="https://www.inchmeal.io/about/">about</a></li>
          
        
        
      </ul>

      <ul class="left">
        <li class="divider"></li>
        

              

          
          
        

              

          
          
        

              

          
          
        
        
      </ul>
    </section>
  </nav>
</div><!-- /#navigation -->


	<!-- capture chapters -IMPORTANT- do not split below statement as it starts capturing new line which causes problems- -->





<!-- remove duplicates, convert to num and insert in array -->

    
    

    

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
            
            

    

    
    

    
        
    

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
    

    

    
    

    
        
    
        
    
        
    

    

    
    

    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    

    
    

    
        
    
        
    
        
    
        
            
            

    




<div class="row t30">
    <div class="medium-4 columns medium-push-8">
    </div>
    <div class="medium-8 columns medium-pull-4">
        <div class="row">
            <div class="medium-11 medium-offset-1 columns">
            <h1><a href="/sicp/index.html" >SICP Solutions</a></h1>
            </div>
        </div>
    </div>
</div>

<div class="row t10">
    <div class="medium-3 columns medium-push-9">
        <div class="row t5">
            <div class="medium-12 columns">

                <ul class="accordion" data-accordion>
                    

                    
                    

                    <li class="accordion-navigation">
                        <a href="#ch-1">Chapter 1</a>
                        
                        <div id="ch-1" class="content ">
                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/notes.html" ><span class="radius info label  icon-edit"></span></a>
                            

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.1.html" ><span class="radius info label ">1.1</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.2.html" ><span class="radius info label ">1.2</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.3.html" ><span class="radius info label ">1.3</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.4.html" ><span class="radius info label ">1.4</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.5.html" ><span class="radius info label ">1.5</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.6.html" ><span class="radius info label ">1.6</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.7.html" ><span class="radius info label ">1.7</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.8.html" ><span class="radius info label ">1.8</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.9.html" ><span class="radius info label ">1.9</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.10.html" ><span class="radius info label ">1.10</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.11.html" ><span class="radius info label ">1.11</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.12.html" ><span class="radius info label ">1.12</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.13.html" ><span class="radius info label ">1.13</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.14.html" ><span class="radius info label todo">1.14</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.15.html" ><span class="radius info label ">1.15</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.16.html" ><span class="radius info label ">1.16</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.17.html" ><span class="radius info label ">1.17</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.18.html" ><span class="radius info label ">1.18</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.19.html" ><span class="radius info label ">1.19</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.20.html" ><span class="radius info label ">1.20</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.21.html" ><span class="radius info label ">1.21</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.22.html" ><span class="radius info label ">1.22</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.23.html" ><span class="radius info label ">1.23</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.24.html" ><span class="radius info label ">1.24</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.25.html" ><span class="radius info label ">1.25</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.26.html" ><span class="radius info label ">1.26</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.27.html" ><span class="radius info label ">1.27</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.28.html" ><span class="radius info label ">1.28</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.29.html" ><span class="radius info label ">1.29</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.30.html" ><span class="radius info label ">1.30</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.31.html" ><span class="radius info label ">1.31</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.32.html" ><span class="radius info label ">1.32</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.33.html" ><span class="radius info label ">1.33</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.34.html" ><span class="radius info label ">1.34</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.35.html" ><span class="radius info label ">1.35</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.36.html" ><span class="radius info label ">1.36</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.37.html" ><span class="radius info label ">1.37</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.38.html" ><span class="radius info label ">1.38</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.39.html" ><span class="radius info label ">1.39</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.40.html" ><span class="radius info label ">1.40</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.41.html" ><span class="radius info label ">1.41</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.42.html" ><span class="radius info label ">1.42</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.43.html" ><span class="radius info label ">1.43</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.44.html" ><span class="radius info label ">1.44</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.45.html" ><span class="radius info label ">1.45</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-1/ex-1.46.html" ><span class="radius info label ">1.46</span></a>
							

                            
                        </div>
                    </li>
                    

                    
                    

                    <li class="accordion-navigation">
                        <a href="#ch-2">Chapter 2</a>
                        
                        <div id="ch-2" class="content ">
                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/notes.html" ><span class="radius info label  icon-edit"></span></a>
                            

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.1.html" ><span class="radius info label ">2.1</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.2.html" ><span class="radius info label ">2.2</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.3.html" ><span class="radius info label ">2.3</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.4.html" ><span class="radius info label ">2.4</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.5.html" ><span class="radius info label ">2.5</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.6.html" ><span class="radius info label ">2.6</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.7.html" ><span class="radius info label ">2.7</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.8.html" ><span class="radius info label ">2.8</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.9.html" ><span class="radius info label ">2.9</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.10.html" ><span class="radius info label ">2.10</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.11.html" ><span class="radius info label ">2.11</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.12.html" ><span class="radius info label ">2.12</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.13.html" ><span class="radius info label ">2.13</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.14.html" ><span class="radius info label ">2.14</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.15.html" ><span class="radius info label ">2.15</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.16.html" ><span class="radius info label todo">2.16</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.17.html" ><span class="radius info label ">2.17</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.18.html" ><span class="radius info label ">2.18</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.19.html" ><span class="radius info label ">2.19</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.20.html" ><span class="radius info label ">2.20</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.21.html" ><span class="radius info label ">2.21</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.22.html" ><span class="radius info label ">2.22</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.23.html" ><span class="radius info label ">2.23</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.24.html" ><span class="radius info label ">2.24</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.25.html" ><span class="radius info label ">2.25</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.26.html" ><span class="radius info label ">2.26</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.27.html" ><span class="radius info label ">2.27</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.28.html" ><span class="radius info label ">2.28</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.29.html" ><span class="radius info label ">2.29</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.30.html" ><span class="radius info label ">2.30</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.31.html" ><span class="radius info label ">2.31</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.32.html" ><span class="radius info label ">2.32</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.33.html" ><span class="radius info label ">2.33</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.34.html" ><span class="radius info label ">2.34</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.35.html" ><span class="radius info label ">2.35</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.36.html" ><span class="radius info label ">2.36</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.37.html" ><span class="radius info label ">2.37</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.38.html" ><span class="radius info label ">2.38</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.39.html" ><span class="radius info label ">2.39</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.40.html" ><span class="radius info label ">2.40</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.41.html" ><span class="radius info label ">2.41</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.42.html" ><span class="radius info label ">2.42</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.43.html" ><span class="radius info label ">2.43</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.44.html" ><span class="radius info label ">2.44</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.45.html" ><span class="radius info label ">2.45</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.46.html" ><span class="radius info label ">2.46</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.47.html" ><span class="radius info label ">2.47</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.48.html" ><span class="radius info label ">2.48</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.49.html" ><span class="radius info label ">2.49</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.50.html" ><span class="radius info label ">2.50</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.51.html" ><span class="radius info label ">2.51</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.52.html" ><span class="radius info label ">2.52</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.53.html" ><span class="radius info label ">2.53</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.54.html" ><span class="radius info label ">2.54</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.55.html" ><span class="radius info label ">2.55</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.56.html" ><span class="radius info label ">2.56</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.57.html" ><span class="radius info label ">2.57</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.58.html" ><span class="radius info label ">2.58</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.59.html" ><span class="radius info label ">2.59</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.60.html" ><span class="radius info label ">2.60</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.61.html" ><span class="radius info label ">2.61</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.62.html" ><span class="radius info label ">2.62</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.63.html" ><span class="radius info label ">2.63</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.64.html" ><span class="radius info label ">2.64</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.65.html" ><span class="radius info label ">2.65</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.66.html" ><span class="radius info label ">2.66</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.67.html" ><span class="radius info label ">2.67</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.68.html" ><span class="radius info label ">2.68</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.69.html" ><span class="radius info label ">2.69</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.70.html" ><span class="radius info label ">2.70</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.71.html" ><span class="radius info label ">2.71</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.72.html" ><span class="radius info label ">2.72</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.73.html" ><span class="radius info label ">2.73</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.74.html" ><span class="radius info label ">2.74</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.75.html" ><span class="radius info label ">2.75</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.76.html" ><span class="radius info label ">2.76</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.77.html" ><span class="radius info label ">2.77</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.78.html" ><span class="radius info label ">2.78</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.79.html" ><span class="radius info label ">2.79</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.80.html" ><span class="radius info label ">2.80</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.81.html" ><span class="radius info label ">2.81</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.82.html" ><span class="radius info label ">2.82</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.83.html" ><span class="radius info label ">2.83</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.84.html" ><span class="radius info label ">2.84</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.85.html" ><span class="radius info label ">2.85</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.86.html" ><span class="radius info label ">2.86</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.87.html" ><span class="radius info label ">2.87</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.88.html" ><span class="radius info label ">2.88</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.89.html" ><span class="radius info label ">2.89</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.90.html" ><span class="radius info label ">2.90</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.91.html" ><span class="radius info label ">2.91</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.92.html" ><span class="radius info label ">2.92</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.93.html" ><span class="radius info label ">2.93</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.94.html" ><span class="radius info label ">2.94</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.95.html" ><span class="radius info label ">2.95</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.96.html" ><span class="radius info label ">2.96</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-2/ex-2.97.html" ><span class="radius info label ">2.97</span></a>
							

                            
                        </div>
                    </li>
                    

                    
                    

                    <li class="accordion-navigation">
                        <a href="#ch-3">Chapter 3</a>
                        
                        <div id="ch-3" class="content ">
                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/notes.html" ><span class="radius info label  icon-edit"></span></a>
                            

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.1.html" ><span class="radius info label ">3.1</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.2.html" ><span class="radius info label ">3.2</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.3.html" ><span class="radius info label ">3.3</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.4.html" ><span class="radius info label ">3.4</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.5.html" ><span class="radius info label ">3.5</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.6.html" ><span class="radius info label ">3.6</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.7.html" ><span class="radius info label ">3.7</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.8.html" ><span class="radius info label ">3.8</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.9.html" ><span class="radius info label ">3.9</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.10.html" ><span class="radius info label ">3.10</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.11.html" ><span class="radius info label ">3.11</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.12.html" ><span class="radius info label ">3.12</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.13.html" ><span class="radius info label ">3.13</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.14.html" ><span class="radius info label ">3.14</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.15.html" ><span class="radius info label todo">3.15</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.16.html" ><span class="radius info label ">3.16</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.17.html" ><span class="radius info label ">3.17</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.18.html" ><span class="radius info label ">3.18</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.19.html" ><span class="radius info label ">3.19</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.20.html" ><span class="radius info label todo">3.20</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.21.html" ><span class="radius info label ">3.21</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.22.html" ><span class="radius info label ">3.22</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.23.html" ><span class="radius info label ">3.23</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.24.html" ><span class="radius info label ">3.24</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.25.html" ><span class="radius info label ">3.25</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.26.html" ><span class="radius info label ">3.26</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.27.html" ><span class="radius info label ">3.27</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.28.html" ><span class="radius info label ">3.28</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.29.html" ><span class="radius info label ">3.29</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.30.html" ><span class="radius info label ">3.30</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.31.html" ><span class="radius info label ">3.31</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.32.html" ><span class="radius info label ">3.32</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.33.html" ><span class="radius info label ">3.33</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.34.html" ><span class="radius info label ">3.34</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.35.html" ><span class="radius info label ">3.35</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.36.html" ><span class="radius info label todo">3.36</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.37.html" ><span class="radius info label ">3.37</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.38.html" ><span class="radius info label ">3.38</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.39.html" ><span class="radius info label ">3.39</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.40.html" ><span class="radius info label ">3.40</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.41.html" ><span class="radius info label ">3.41</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.42.html" ><span class="radius info label ">3.42</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.43.html" ><span class="radius info label ">3.43</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.44.html" ><span class="radius info label ">3.44</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.45.html" ><span class="radius info label ">3.45</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.46.html" ><span class="radius info label ">3.46</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.47.html" ><span class="radius info label ">3.47</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.48.html" ><span class="radius info label ">3.48</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.49.html" ><span class="radius info label ">3.49</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.50.html" ><span class="radius info label ">3.50</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.51.html" ><span class="radius info label ">3.51</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.52.html" ><span class="radius info label ">3.52</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.53.html" ><span class="radius info label ">3.53</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.54.html" ><span class="radius info label ">3.54</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.55.html" ><span class="radius info label ">3.55</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.56.html" ><span class="radius info label ">3.56</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.57.html" ><span class="radius info label ">3.57</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.58.html" ><span class="radius info label ">3.58</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.59.html" ><span class="radius info label ">3.59</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.60.html" ><span class="radius info label ">3.60</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.61.html" ><span class="radius info label ">3.61</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.62.html" ><span class="radius info label ">3.62</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.63.html" ><span class="radius info label ">3.63</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.64.html" ><span class="radius info label ">3.64</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.65.html" ><span class="radius info label ">3.65</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.66.html" ><span class="radius info label ">3.66</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.67.html" ><span class="radius info label ">3.67</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.68.html" ><span class="radius info label ">3.68</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.69.html" ><span class="radius info label ">3.69</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.70.html" ><span class="radius info label ">3.70</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.71.html" ><span class="radius info label ">3.71</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.72.html" ><span class="radius info label ">3.72</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.73.html" ><span class="radius info label ">3.73</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.74.html" ><span class="radius info label ">3.74</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.75.html" ><span class="radius info label ">3.75</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.76.html" ><span class="radius info label ">3.76</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.77.html" ><span class="radius info label ">3.77</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.78.html" ><span class="radius info label ">3.78</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.79.html" ><span class="radius info label ">3.79</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.80.html" ><span class="radius info label ">3.80</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.81.html" ><span class="radius info label ">3.81</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-3/ex-3.82.html" ><span class="radius info label ">3.82</span></a>
							

                            
                        </div>
                    </li>
                    

                    
                    

                    <li class="accordion-navigation">
                        <a href="#ch-4">Chapter 4</a>
                        
                        <div id="ch-4" class="content active">
                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/notes.html" ><span class="radius info label  icon-edit"></span></a>
                            

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.1.html" ><span class="radius info label ">4.1</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.2.html" ><span class="radius info label ">4.2</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.3.html" ><span class="radius info label ">4.3</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.4.html" ><span class="radius info label ">4.4</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.5.html" ><span class="radius info label ">4.5</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.6.html" ><span class="radius info label ">4.6</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.7.html" ><span class="radius info label ">4.7</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.8.html" ><span class="radius info label ">4.8</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.9.html" ><span class="radius info label ">4.9</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.10.html" ><span class="radius info label todo">4.10</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.11.html" ><span class="radius info label ">4.11</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.12.html" ><span class="radius info label ">4.12</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.13.html" ><span class="radius info label ">4.13</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.14.html" ><span class="radius info label ">4.14</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.15.html" ><span class="radius info label ">4.15</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.16.html" ><span class="radius info label ">4.16</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.17.html" ><span class="radius info label ">4.17</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.18.html" ><span class="radius info label ">4.18</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.19.html" ><span class="radius info label ">4.19</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.20.html" ><span class="radius info label ">4.20</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.21.html" ><span class="radius info label ">4.21</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.22.html" ><span class="radius info label ">4.22</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.23.html" ><span class="radius info label ">4.23</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.24.html" ><span class="radius info label ">4.24</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.25.html" ><span class="radius info label ">4.25</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.26.html" ><span class="radius info label ">4.26</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.27.html" ><span class="radius info label ">4.27</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.28.html" ><span class="radius info label ">4.28</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.29.html" ><span class="radius info label ">4.29</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.30.html" ><span class="radius info label ">4.30</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.31.html" ><span class="radius info label ">4.31</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.32.html" ><span class="radius info label ">4.32</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.33.html" ><span class="radius info label ">4.33</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.34.html" ><span class="radius info label ">4.34</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.35.html" ><span class="radius info label ">4.35</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.36.html" ><span class="radius info label ">4.36</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.37.html" ><span class="radius info label ">4.37</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.38.html" ><span class="radius info label ">4.38</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.39.html" ><span class="radius info label ">4.39</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.40.html" ><span class="radius info label ">4.40</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.41.html" ><span class="radius info label ">4.41</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.42.html" ><span class="radius info label ">4.42</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.43.html" ><span class="radius info label ">4.43</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.44.html" ><span class="radius info label ">4.44</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.45.html" ><span class="radius info label ">4.45</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.46.html" ><span class="radius info label ">4.46</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.47.html" ><span class="radius info label ">4.47</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.48.html" ><span class="radius info label ">4.48</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.49.html" ><span class="radius info label ">4.49</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.50.html" ><span class="radius info label ">4.50</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.51.html" ><span class="radius info label ">4.51</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.52.html" ><span class="radius info label ">4.52</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.53.html" ><span class="radius info label ">4.53</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.54.html" ><span class="radius info label ">4.54</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.55.html" ><span class="radius info label ">4.55</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.56.html" ><span class="radius info label ">4.56</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.57.html" ><span class="radius info label ">4.57</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.58.html" ><span class="radius info label ">4.58</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.59.html" ><span class="radius info label ">4.59</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.60.html" ><span class="radius info label ">4.60</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.61.html" ><span class="radius info label ">4.61</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.62.html" ><span class="radius info label ">4.62</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.63.html" ><span class="radius info label ">4.63</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.64.html" ><span class="radius info label ">4.64</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.65.html" ><span class="radius info label ">4.65</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.66.html" ><span class="radius info label ">4.66</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.67.html" ><span class="radius info label ">4.67</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.68.html" ><span class="radius info label ">4.68</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.69.html" ><span class="radius info label ">4.69</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.70.html" ><span class="radius info label ">4.70</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.71.html" ><span class="radius info label ">4.71</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.72.html" ><span class="radius info label ">4.72</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.73.html" ><span class="radius info label ">4.73</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.74.html" ><span class="radius info label ">4.74</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.75.html" ><span class="radius info label ">4.75</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.76.html" ><span class="radius info label ">4.76</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.77.html" ><span class="radius info label ">4.77</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.78.html" ><span class="radius success label ">4.78</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-4/ex-4.79.html" ><span class="radius info label todo">4.79</span></a>
							

                            
                        </div>
                    </li>
                    

                    
                    

                    <li class="accordion-navigation">
                        <a href="#ch-5">Chapter 5</a>
                        
                        <div id="ch-5" class="content ">
                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/notes.html" ><span class="radius info label  icon-edit"></span></a>
                            

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.1.html" ><span class="radius info label ">5.1</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.2.html" ><span class="radius info label ">5.2</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.3.html" ><span class="radius info label ">5.3</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.4.html" ><span class="radius info label ">5.4</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.5.html" ><span class="radius info label ">5.5</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.6.html" ><span class="radius info label ">5.6</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.7.html" ><span class="radius info label ">5.7</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.8.html" ><span class="radius info label ">5.8</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.9.html" ><span class="radius info label ">5.9</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.10.html" ><span class="radius info label ">5.10</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.11.html" ><span class="radius info label ">5.11</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.12.html" ><span class="radius info label ">5.12</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.13.html" ><span class="radius info label ">5.13</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.14.html" ><span class="radius info label ">5.14</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.15.html" ><span class="radius info label ">5.15</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.16.html" ><span class="radius info label ">5.16</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.17.html" ><span class="radius info label ">5.17</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.18.html" ><span class="radius info label ">5.18</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.19.html" ><span class="radius info label ">5.19</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.20.html" ><span class="radius info label ">5.20</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.21.html" ><span class="radius info label ">5.21</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.22.html" ><span class="radius info label ">5.22</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.23.html" ><span class="radius info label ">5.23</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.24.html" ><span class="radius info label ">5.24</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.25.html" ><span class="radius info label ">5.25</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.26.html" ><span class="radius info label ">5.26</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.27.html" ><span class="radius info label ">5.27</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.28.html" ><span class="radius info label ">5.28</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.29.html" ><span class="radius info label ">5.29</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.30.html" ><span class="radius info label todo">5.30</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.31.html" ><span class="radius info label ">5.31</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.32.html" ><span class="radius info label ">5.32</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.33.html" ><span class="radius info label ">5.33</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.34.html" ><span class="radius info label ">5.34</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.35.html" ><span class="radius info label ">5.35</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.36.html" ><span class="radius info label ">5.36</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.37.html" ><span class="radius info label ">5.37</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.38.html" ><span class="radius info label ">5.38</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.39.html" ><span class="radius info label ">5.39</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.40.html" ><span class="radius info label ">5.40</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.41.html" ><span class="radius info label ">5.41</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.42.html" ><span class="radius info label ">5.42</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.43.html" ><span class="radius info label ">5.43</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.44.html" ><span class="radius info label ">5.44</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.45.html" ><span class="radius info label ">5.45</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.46.html" ><span class="radius info label ">5.46</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.47.html" ><span class="radius info label ">5.47</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.48.html" ><span class="radius info label ">5.48</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.49.html" ><span class="radius info label ">5.49</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.50.html" ><span class="radius info label ">5.50</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.51.html" ><span class="radius info label todo">5.51</span></a>
							

                            
                            

                            

                            

                            
							    <a href="/sicp/ch-5/ex-5.52.html" ><span class="radius info label todo">5.52</span></a>
							

                            
                        </div>
                    </li>
                    
                </ul>

                <div class="show-for-small-down">
                    <hr class="t20"/>
                </div>

            </div>
        </div>
    </div><!-- /.medium-4.columns -->
    <div class="medium-9 columns medium-pull-3">
        <div class="row">
            <div class="medium-11 medium-offset-1 columns">
                <article itemscope itemtype="http://schema.org/Article">
                    <header>
                        <span itemprop="name">
                            
                            <h3>Chapter 4, Metalinguistic Abstraction</h3>
                            
                            
								
								
								<h4>Exercise 4.78</h4>
								
							
                        </span>
                    </header>

                    
                    <p class="tm10">
                        <time class="post-date pr20" datetime="April 12, 2018" itemprop="datePublished"> April 12, 2018</time>
                    </p>
                    

                    <span itemprop="articleSection">
                        <hr/>
                        <p>Interesting! Learned a few subtle details of the non-deterministic computing from the previous section.</p>

<p>The complete code is at the bottom of this page.</p>

<p>Apart from these subtle details, the solution is not difficult. Perhaps, if i have learned these few subtle things in the previous section itself than this could have turned out much easier.</p>

<p>So, here goes the approach:</p>

<ul>
  <li>
    <p>Since, non-deterministic evaluator itself tries out all the possibilities, we only need to handle one frame in every procedure.</p>
  </li>
  <li>
    <p>Instead of marking frame as <code class="highlighter-rouge">'failed</code>, mark it as dead end using <code class="highlighter-rouge">(amb)</code> and which will cause evaluator to try other possible paths.</p>
  </li>
  <li>
    <p>Install all the host language <strong>immutable</strong> procedures used in the logic evaluator(like <code class="highlighter-rouge">'assoc</code>, <code class="highlighter-rouge">'string=?</code> etc) as primitive procedures in the non-deterministic evaluator.</p>
  </li>
  <li>Mutable procedures are more subtle and can not be directly used as primitive procedures. For eg:
    <ul>
      <li>primitve <code class="highlighter-rouge">set!</code> won’t work
        <ul>
          <li>we already implemented it as special form but it’s important to understand why we can’t use the primitive form.</li>
          <li>the variable we are changing is defined in our environment not in the host language.</li>
          <li>we can not roll back to previous value.</li>
        </ul>
      </li>
      <li>
        <p>primitve <code class="highlighter-rouge">set-car!</code> and <code class="highlighter-rouge">set-cdr</code> won’t work because we can not roll back to previous value.</p>
      </li>
      <li>primitive <code class="highlighter-rouge">display</code> won’t work because it does not return any value. The way non-deterministic evaluator is written, we always need a value to pass into <code class="highlighter-rouge">success</code> procedure!</li>
    </ul>
  </li>
  <li>
    <p>For <code class="highlighter-rouge">display</code>, we can implement a <code class="highlighter-rouge">display</code> in the code of non-deterministic evaluator which returns a value like <code class="highlighter-rouge">'ok</code>.</p>
  </li>
  <li>
    <p>Note that while executing a program in the non-deterministic evaluator, the program won’t try any other paths unless an <code class="highlighter-rouge">amb</code> expression is encountered.</p>
  </li>
  <li>
    <p>Thus all the procedures and initialization code for <code class="highlighter-rouge">microshaft</code> database will work as in a normal evaluator implemented in the first section.</p>
  </li>
  <li>
    <p>Since all the <em>mutations</em> happen in initialization code for <code class="highlighter-rouge">microshaft</code> database, we can even choose to implement <code class="highlighter-rouge">set-car!</code> as <code class="highlighter-rouge">permanent-set-car!</code>. But for consistency, it might be better to support rollback.</p>
  </li>
  <li>This example explains why not to use <code class="highlighter-rouge">define</code> for <em>variable</em>(here aa or bb) definitions(procedure will work) and instead use <code class="highlighter-rouge">let</code>:</li>
</ul>

<figure class="highlight"><pre><code class="language-scheme" data-lang="scheme"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
</pre></td><td class="code"><pre><span class="c1">;;; Amb-Eval input:</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">aa</span> <span class="p">(</span><span class="nf">amb</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">))</span>
<span class="c1">;;; Starting a new problem </span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="nv">ok</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">bb</span> <span class="p">(</span><span class="nf">amb</span> <span class="mi">10</span> <span class="mi">20</span> <span class="mi">30</span><span class="p">))</span>
<span class="c1">;;; Starting a new problem </span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="nv">ok</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="p">(</span><span class="nf">amb</span> <span class="nv">aa</span> <span class="nv">bb</span><span class="p">)</span>
<span class="c1">;;; Starting a new problem </span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="mi">1</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="nv">try-again</span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="mi">10</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="nv">try-again</span>
<span class="c1">;;; There are no more values of</span>
<span class="p">(</span><span class="nf">amb</span> <span class="nv">aa</span> <span class="nv">bb</span><span class="p">)</span>
<span class="c1">;;; Amb-Eval input:</span></pre></td></tr></tbody></table></code></pre></figure>

<p>This problem won’t occur with using <code class="highlighter-rouge">let</code>.</p>

<ul>
  <li>To support <code class="highlighter-rouge">interleaving</code>, I considered using <code class="highlighter-rouge">ramb</code>(implemented in previous section ex-4.50) but it won’t work as once it chooses a path then it first generates all the values from that path and then it chooses the other path. For example:</li>
</ul>

<figure class="highlight"><pre><code class="language-scheme" data-lang="scheme"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre></td><td class="code"><pre><span class="c1">;;; Amb-Eval input:</span>
<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">ff</span><span class="p">)</span> <span class="p">(</span><span class="nf">amb</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">))</span>
<span class="c1">;;; Starting a new problem </span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="nv">ok</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">gg</span><span class="p">)</span> <span class="p">(</span><span class="nf">amb</span> <span class="mi">10</span> <span class="mi">20</span> <span class="mi">30</span><span class="p">))</span>
<span class="c1">;;; Starting a new problem </span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="nv">ok</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="p">(</span><span class="nf">ramb</span> <span class="p">(</span><span class="nf">ff</span><span class="p">)</span> <span class="p">(</span><span class="nf">gg</span><span class="p">))</span>
<span class="c1">;;; Starting a new problem </span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="mi">1</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="nv">try-again</span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="mi">2</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="nv">try-again</span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="mi">3</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="nv">try-again</span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="mi">10</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="nv">try-again</span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="mi">20</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="nv">try-again</span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="mi">30</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="nv">try-again</span>
<span class="c1">;;; There are no more values of</span>
<span class="p">(</span><span class="nf">ramb</span> <span class="p">(</span><span class="nf">ff</span><span class="p">)</span> <span class="p">(</span><span class="nf">gg</span><span class="p">))</span></pre></td></tr></tbody></table></code></pre></figure>

<p>We can solve this using <code class="highlighter-rouge">let</code> but it has its own problem. We get duplicates because it tries all combinations(remember distinct!):</p>

<figure class="highlight"><pre><code class="language-scheme" data-lang="scheme"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre></td><td class="code"><pre><span class="c1">;;; Amb-Eval input:</span>
<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">test</span><span class="p">)</span> <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">aa</span> <span class="p">(</span><span class="nf">amb</span> <span class="mi">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">))</span>
					 <span class="p">(</span><span class="nf">bb</span> <span class="p">(</span><span class="nf">amb</span> <span class="mi">10</span> <span class="mi">20</span> <span class="mi">30</span><span class="p">)))</span>
				 <span class="p">(</span><span class="nf">ramb</span> <span class="nv">aa</span> <span class="nv">bb</span><span class="p">)))</span>
<span class="c1">;;; Starting a new problem </span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="nv">ok</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="p">(</span><span class="nf">test</span><span class="p">)</span>
<span class="c1">;;; Starting a new problem </span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="mi">1</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="nv">try-again</span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="mi">10</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="nv">try-again</span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="mi">20</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="nv">try-again</span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="mi">1</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="nv">try-again</span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="mi">30</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="nv">try-again</span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="mi">1</span>
<span class="c1">;;; Amb-Eval input:</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Keeping track of duplicates, might solve this by providing a special form in the non-deterministic evaluator. I left it without interleaving. Probably, there can be other better solution without keeping track which I have not thought.</p>

<ul>
  <li>Implementing <code class="highlighter-rouge">not</code> turned out to be more involved. We need a way to know that if a query results in a <em>failure</em>. It sorts of look like using <code class="highlighter-rouge">if-fail</code>(ex-4.52) can do the job as follows:</li>
</ul>

<figure class="highlight"><pre><code class="language-scheme" data-lang="scheme"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">negate</span> <span class="nv">operands</span> <span class="nv">frame</span><span class="p">)</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">eq?</span>
	   <span class="p">(</span><span class="nf">if-fail</span> <span class="p">(</span><span class="nf">qeval</span> <span class="p">(</span><span class="nf">negated-query</span> <span class="nv">operands</span><span class="p">)</span>
					   <span class="nv">frame</span><span class="p">)</span>
				<span class="ss">'failed</span><span class="p">)</span>
	   <span class="ss">'failed</span><span class="p">)</span>
	  <span class="nv">frame</span>
	  <span class="p">(</span><span class="nf">amb</span><span class="p">)))</span></pre></td></tr></tbody></table></code></pre></figure>

<p>But it did not work! Why? Because when <code class="highlighter-rouge">qeval</code> failed, we correctly get <code class="highlighter-rouge">'failed</code> which causes the evaluation of <code class="highlighter-rouge">(amb)</code>. And evaluating <code class="highlighter-rouge">(amb)</code> caused to look for alternate path. This alternate path takes us to <code class="highlighter-rouge">if-fail</code> again which returns <code class="highlighter-rouge">'failed</code> as alternate path(failed path). And thus <code class="highlighter-rouge">if</code> returned the <code class="highlighter-rouge">frame</code> even when <code class="highlighter-rouge">qeval</code> failed!</p>

<p>This made me realise that we don’t need a construct like <code class="highlighter-rouge">if-fail</code> but something like <code class="highlighter-rouge">(amb)</code> but that accepts an argument and fails if that argument succeeds. This lead to the implementation of <code class="highlighter-rouge">ensure-fail</code>. The code <code class="highlighter-rouge">(ensure-fail &lt;exp1&gt;) &lt;exp2&gt;</code> will evaluate <code class="highlighter-rouge">&lt;exp2&gt;</code> only if <code class="highlighter-rouge">&lt;exp1&gt;</code> failed. Here goes it’s implementation:</p>

<figure class="highlight"><pre><code class="language-scheme" data-lang="scheme"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre></td><td class="code"><pre><span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">ensure-fail?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nf">tagged-list?</span> <span class="nv">exp</span> <span class="ss">'ensure-fail</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">ensure-fail-expression</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nb">cadr</span> <span class="nv">exp</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">analyze-ensure-fail</span> <span class="nv">exp</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">expr</span> <span class="p">(</span><span class="nf">analyze</span> <span class="p">(</span><span class="nf">ensure-fail-expression</span> <span class="nv">exp</span><span class="p">))))</span>
	<span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">env</span> <span class="nv">succeed</span> <span class="nv">fail</span><span class="p">)</span>
	  <span class="p">(</span><span class="nf">expr</span> <span class="nv">env</span>
			  <span class="p">(</span><span class="k">lambda</span><span class="p">(</span><span class="nf">ignore</span> <span class="nv">fail2</span><span class="p">)</span> <span class="p">(</span><span class="nf">fail</span><span class="p">))</span>
			  <span class="p">(</span><span class="k">lambda</span><span class="p">()</span> <span class="p">(</span><span class="nf">succeed</span> <span class="ss">'ok</span> <span class="nv">fail</span><span class="p">))))))</span></pre></td></tr></tbody></table></code></pre></figure>

<ul>
  <li>Now, there is still one thing remaining <code class="highlighter-rouge">lisp-value</code>, which requires this procedure to be evaluated in the non-deterministic evaluator.</li>
</ul>

<figure class="highlight"><pre><code class="language-scheme" data-lang="scheme"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
</pre></td><td class="code"><pre><span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">execute</span> <span class="nv">exp</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">apply</span> <span class="p">(</span><span class="nb">eval</span> <span class="p">(</span><span class="nf">predicate</span> <span class="nv">exp</span><span class="p">)</span> <span class="nv">user-initial-environment</span><span class="p">)</span>
         <span class="p">(</span><span class="nf">args</span> <span class="nv">exp</span><span class="p">)))</span></pre></td></tr></tbody></table></code></pre></figure>

<p>This can be solved simply providing <code class="highlighter-rouge">eval</code> and <code class="highlighter-rouge">appply</code> of our non-deterministic evaluator as primitive procedures. And <code class="highlighter-rouge">user-initial-environment</code> can be set similar to the way we set <code class="highlighter-rouge">true</code> and <code class="highlighter-rouge">false</code> in the <code class="highlighter-rouge">setup-environment</code>:</p>

<figure class="highlight"><pre><code class="language-scheme" data-lang="scheme"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre></td><td class="code"><pre><span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">setup-environment</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">initial-env</span>
         <span class="p">(</span><span class="nf">extend-environment</span> <span class="p">(</span><span class="nf">primitive-procedure-names</span><span class="p">)</span>
                             <span class="p">(</span><span class="nf">primitive-procedure-objects</span><span class="p">)</span>
                             <span class="nv">the-empty-environment</span><span class="p">)))</span>
    <span class="p">(</span><span class="nf">define-variable!</span> <span class="ss">'true</span> <span class="nv">true</span> <span class="nv">initial-env</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">define-variable!</span> <span class="ss">'false</span> <span class="nv">false</span> <span class="nv">initial-env</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">define-variable!</span> <span class="ss">'user-initial-environment</span> <span class="nv">initial-env</span> <span class="nv">initial-env</span><span class="p">)</span>
    <span class="nv">initial-env</span><span class="p">))</span></pre></td></tr></tbody></table></code></pre></figure>

<ul>
  <li><em>Driver Loop</em>: Since the non-deterministic evaluator will run in driver loop, I implemented a procedure <code class="highlighter-rouge">lp</code>. It can be called as <code class="highlighter-rouge">(lp '(supervisor ?x (Bitdiddle Ben)))</code> for executing a query. Or for assertion use:</li>
</ul>

<figure class="highlight"><pre><code class="language-scheme" data-lang="scheme"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre></td><td class="code"><pre><span class="p">(</span><span class="nf">lp</span> <span class="o">'</span><span class="p">(</span><span class="nf">assert!</span>
 <span class="p">(</span><span class="nf">rule</span> <span class="p">(</span><span class="nf">can-replace</span> <span class="nv">?per1</span> <span class="nv">?per2</span><span class="p">)</span>
	   <span class="p">(</span><span class="k">and</span> <span class="p">(</span><span class="nf">job</span> <span class="nv">?per1</span> <span class="nv">?job1</span><span class="p">)</span>
			<span class="p">(</span><span class="nf">job</span> <span class="nv">?per2</span> <span class="nv">?job2</span><span class="p">)</span>
			<span class="p">(</span><span class="nb">not</span> <span class="p">(</span><span class="nf">same</span> <span class="nv">?per1</span> <span class="nv">?per2</span><span class="p">))</span>
			<span class="p">(</span><span class="k">or</span> <span class="p">(</span><span class="nf">same</span> <span class="nv">?job1</span> <span class="nv">?job2</span><span class="p">)</span>
				<span class="p">(</span><span class="nf">can-do-job</span> <span class="nv">?job1</span> <span class="nv">?job2</span><span class="p">))))))</span></pre></td></tr></tbody></table></code></pre></figure>

<p>Well thats it!</p>

<p>So, as already mentioned the main point that differ with the streams, is <code class="highlighter-rouge">interleaving</code>. This gets worse with multiple infinite frames/results as it may keep answering only from one path and never evaluates the other paths! Thus the order of answers won’t be same as in the streams version.</p>

<h3 id="execution-and-some-examples">Execution and some examples:</h3>

<ul>
  <li>Clear the environment. In scheme, I use this:</li>
</ul>

<figure class="highlight"><pre><code class="language-scheme" data-lang="scheme"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
</pre></td><td class="code"><pre><span class="p">(</span><span class="nf">ge</span> <span class="p">(</span><span class="nf">make-top-level-environment</span><span class="p">))</span>
<span class="p">(</span><span class="nf">restart</span> <span class="mi">1</span><span class="p">)</span></pre></td></tr></tbody></table></code></pre></figure>

<ul>
  <li>
    <p>Now start the non-deterministic evaluator.</p>
  </li>
  <li>
    <p>Evaluate the modified logic evaluator in non-deterministic evaluator. In emacs this can be done by a simple command to send the contents of a buffer to repl(where our driver loop is running).</p>
  </li>
  <li>
    <p>If initilization for database is not inside the evaluator, then do it now by invoking <code class="highlighter-rouge">(initialize-data-base microshaft-data-base)</code>.</p>
  </li>
  <li>
    <p>That’s it. Few examples of it working:</p>
  </li>
</ul>

<figure class="highlight"><pre><code class="language-scheme" data-lang="scheme"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
</pre></td><td class="code"><pre><span class="c1">;;; Amb-Eval input:</span>
<span class="p">(</span><span class="nf">initialize-data-base</span> <span class="nv">microshaft-data-base</span><span class="p">)</span>
<span class="c1">;;; Starting a new problem </span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="nv">done</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="p">(</span><span class="nf">lp</span> <span class="o">'</span><span class="p">(</span><span class="k">and</span> <span class="p">(</span><span class="nf">salary</span> <span class="p">(</span><span class="nf">Bitdiddle</span> <span class="nv">Ben</span><span class="p">)</span> <span class="nv">?ben-sal</span><span class="p">)</span> <span class="p">(</span><span class="k">and</span> <span class="p">(</span><span class="nf">salary</span> <span class="nv">?name</span> <span class="nv">?sal</span><span class="p">)</span> <span class="p">(</span><span class="nf">lisp-value</span> <span class="nv">&lt;</span> <span class="nv">?sal</span> <span class="nv">?ben-sal</span><span class="p">))))</span>
<span class="c1">;;; Starting a new problem </span>
<span class="p">(</span><span class="nf">Query</span> <span class="nv">Results:</span><span class="p">)</span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="p">(</span><span class="k">and</span> <span class="p">(</span><span class="nf">salary</span> <span class="p">(</span><span class="nf">bitdiddle</span> <span class="nv">ben</span><span class="p">)</span> <span class="mi">60000</span><span class="p">)</span> <span class="p">(</span><span class="k">and</span> <span class="p">(</span><span class="nf">salary</span> <span class="p">(</span><span class="nf">aull</span> <span class="nv">dewitt</span><span class="p">)</span> <span class="mi">25000</span><span class="p">)</span> <span class="p">(</span><span class="nf">lisp-value</span> <span class="nv">&lt;</span> <span class="mi">25000</span> <span class="mi">60000</span><span class="p">)))</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="nv">try-again</span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="p">(</span><span class="k">and</span> <span class="p">(</span><span class="nf">salary</span> <span class="p">(</span><span class="nf">bitdiddle</span> <span class="nv">ben</span><span class="p">)</span> <span class="mi">60000</span><span class="p">)</span> <span class="p">(</span><span class="k">and</span> <span class="p">(</span><span class="nf">salary</span> <span class="p">(</span><span class="nf">cratchet</span> <span class="nv">robert</span><span class="p">)</span> <span class="mi">18000</span><span class="p">)</span> <span class="p">(</span><span class="nf">lisp-value</span> <span class="nv">&lt;</span> <span class="mi">18000</span> <span class="mi">60000</span><span class="p">)))</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="nv">try-again</span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="p">(</span><span class="k">and</span> <span class="p">(</span><span class="nf">salary</span> <span class="p">(</span><span class="nf">bitdiddle</span> <span class="nv">ben</span><span class="p">)</span> <span class="mi">60000</span><span class="p">)</span> <span class="p">(</span><span class="k">and</span> <span class="p">(</span><span class="nf">salary</span> <span class="p">(</span><span class="nf">reasoner</span> <span class="nv">louis</span><span class="p">)</span> <span class="mi">30000</span><span class="p">)</span> <span class="p">(</span><span class="nf">lisp-value</span> <span class="nv">&lt;</span> <span class="mi">30000</span> <span class="mi">60000</span><span class="p">)))</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="nv">try-again</span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="p">(</span><span class="k">and</span> <span class="p">(</span><span class="nf">salary</span> <span class="p">(</span><span class="nf">bitdiddle</span> <span class="nv">ben</span><span class="p">)</span> <span class="mi">60000</span><span class="p">)</span> <span class="p">(</span><span class="k">and</span> <span class="p">(</span><span class="nf">salary</span> <span class="p">(</span><span class="nf">tweakit</span> <span class="nv">lem</span> <span class="nv">e</span><span class="p">)</span> <span class="mi">25000</span><span class="p">)</span> <span class="p">(</span><span class="nf">lisp-value</span> <span class="nv">&lt;</span> <span class="mi">25000</span> <span class="mi">60000</span><span class="p">)))</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="nv">try-again</span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="p">(</span><span class="k">and</span> <span class="p">(</span><span class="nf">salary</span> <span class="p">(</span><span class="nf">bitdiddle</span> <span class="nv">ben</span><span class="p">)</span> <span class="mi">60000</span><span class="p">)</span> <span class="p">(</span><span class="k">and</span> <span class="p">(</span><span class="nf">salary</span> <span class="p">(</span><span class="nf">fect</span> <span class="nv">cy</span> <span class="nv">d</span><span class="p">)</span> <span class="mi">35000</span><span class="p">)</span> <span class="p">(</span><span class="nf">lisp-value</span> <span class="nv">&lt;</span> <span class="mi">35000</span> <span class="mi">60000</span><span class="p">)))</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="nv">try-again</span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="p">(</span><span class="k">and</span> <span class="p">(</span><span class="nf">salary</span> <span class="p">(</span><span class="nf">bitdiddle</span> <span class="nv">ben</span><span class="p">)</span> <span class="mi">60000</span><span class="p">)</span> <span class="p">(</span><span class="k">and</span> <span class="p">(</span><span class="nf">salary</span> <span class="p">(</span><span class="nf">hacker</span> <span class="nv">alyssa</span> <span class="nv">p</span><span class="p">)</span> <span class="mi">40000</span><span class="p">)</span> <span class="p">(</span><span class="nf">lisp-value</span> <span class="nv">&lt;</span> <span class="mi">40000</span> <span class="mi">60000</span><span class="p">)))</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="nv">try-again</span>
<span class="c1">;;; There are no more values of</span>
<span class="p">(</span><span class="nf">lp</span> <span class="p">(</span><span class="k">quote</span> <span class="p">(</span><span class="k">and</span> <span class="p">(</span><span class="nf">salary</span> <span class="p">(</span><span class="nf">bitdiddle</span> <span class="nv">ben</span><span class="p">)</span> <span class="nv">?ben-sal</span><span class="p">)</span> <span class="p">(</span><span class="k">and</span> <span class="p">(</span><span class="nf">salary</span> <span class="nv">?name</span> <span class="nv">?sal</span><span class="p">)</span> <span class="p">(</span><span class="nf">lisp-value</span> <span class="nv">&lt;</span> <span class="nv">?sal</span> <span class="nv">?ben-sal</span><span class="p">)))))</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="p">(</span><span class="nf">lp</span> <span class="o">'</span><span class="p">(</span><span class="nf">assert!</span>
 <span class="p">(</span><span class="nf">rule</span> <span class="p">(</span><span class="nf">can-replace</span> <span class="nv">?per1</span> <span class="nv">?per2</span><span class="p">)</span>
	   <span class="p">(</span><span class="k">and</span> <span class="p">(</span><span class="nf">job</span> <span class="nv">?per1</span> <span class="nv">?job1</span><span class="p">)</span>
			<span class="p">(</span><span class="nf">job</span> <span class="nv">?per2</span> <span class="nv">?job2</span><span class="p">)</span>
			<span class="p">(</span><span class="nb">not</span> <span class="p">(</span><span class="nf">same</span> <span class="nv">?per1</span> <span class="nv">?per2</span><span class="p">))</span>
			<span class="p">(</span><span class="k">or</span> <span class="p">(</span><span class="nf">same</span> <span class="nv">?job1</span> <span class="nv">?job2</span><span class="p">)</span>
				<span class="p">(</span><span class="nf">can-do-job</span> <span class="nv">?job1</span> <span class="nv">?job2</span><span class="p">))))))</span>
<span class="c1">;;; Starting a new problem </span>
<span class="p">(</span><span class="nf">Assertion</span> <span class="nv">added</span> <span class="nv">to</span> <span class="nv">data</span> <span class="nv">base</span><span class="o">.</span><span class="p">)</span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="nv">ok</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="p">(</span><span class="nf">lp</span> <span class="o">'</span><span class="p">(</span><span class="nf">can-replace</span> <span class="nv">?per1</span> <span class="p">(</span><span class="nf">Fect</span> <span class="nv">Cy</span> <span class="nv">D</span><span class="p">)))</span>
<span class="c1">;;; Starting a new problem </span>
<span class="p">(</span><span class="nf">Query</span> <span class="nv">Results:</span><span class="p">)</span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="p">(</span><span class="nf">can-replace</span> <span class="p">(</span><span class="nf">hacker</span> <span class="nv">alyssa</span> <span class="nv">p</span><span class="p">)</span> <span class="p">(</span><span class="nf">fect</span> <span class="nv">cy</span> <span class="nv">d</span><span class="p">))</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="nv">try-again</span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="p">(</span><span class="nf">can-replace</span> <span class="p">(</span><span class="nf">bitdiddle</span> <span class="nv">ben</span><span class="p">)</span> <span class="p">(</span><span class="nf">fect</span> <span class="nv">cy</span> <span class="nv">d</span><span class="p">))</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="nv">try-again</span>
<span class="c1">;;; There are no more values of</span>
<span class="p">(</span><span class="nf">lp</span> <span class="p">(</span><span class="k">quote</span> <span class="p">(</span><span class="nf">can-replace</span> <span class="nv">?per1</span> <span class="p">(</span><span class="nf">fect</span> <span class="nv">cy</span> <span class="nv">d</span><span class="p">))))</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="p">(</span><span class="nf">lp</span> <span class="o">'</span><span class="p">(</span><span class="nf">assert!</span> <span class="p">(</span><span class="nf">rule</span> <span class="p">(</span><span class="nf">last-pair</span> <span class="p">(</span><span class="nf">?x</span> <span class="nv">?y</span> <span class="o">.</span> <span class="nv">?z</span><span class="p">)</span> <span class="nv">?r</span><span class="p">)</span>
			   <span class="p">(</span><span class="nf">last-pair</span> <span class="p">(</span><span class="nf">?y</span> <span class="o">.</span> <span class="nv">?z</span><span class="p">)</span> <span class="nv">?r</span><span class="p">))))</span>
<span class="c1">;;; Starting a new problem </span>
<span class="p">(</span><span class="nf">Assertion</span> <span class="nv">added</span> <span class="nv">to</span> <span class="nv">data</span> <span class="nv">base</span><span class="o">.</span><span class="p">)</span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="nv">ok</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="p">(</span><span class="nf">lp</span> <span class="o">'</span><span class="p">(</span><span class="nf">last-pair</span> <span class="p">(</span><span class="nf">3</span><span class="p">)</span> <span class="nv">?x</span><span class="p">))</span>
<span class="c1">;;; Starting a new problem </span>
<span class="p">(</span><span class="nf">Query</span> <span class="nv">Results:</span><span class="p">)</span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="p">(</span><span class="nf">last-pair</span> <span class="p">(</span><span class="nf">3</span><span class="p">)</span> <span class="p">(</span><span class="nf">3</span><span class="p">))</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="p">(</span><span class="nf">lp</span> <span class="o">'</span><span class="p">(</span><span class="nf">last-pair</span> <span class="p">(</span><span class="nf">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">)</span> <span class="nv">?x</span><span class="p">))</span>
<span class="c1">;;; Starting a new problem </span>
<span class="p">(</span><span class="nf">Query</span> <span class="nv">Results:</span><span class="p">)</span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="p">(</span><span class="nf">last-pair</span> <span class="p">(</span><span class="nf">1</span> <span class="mi">2</span> <span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="nf">3</span><span class="p">))</span>
<span class="c1">;;; Amb-Eval input:</span>
<span class="p">(</span><span class="nf">lp</span> <span class="o">'</span><span class="p">(</span><span class="nf">last-pair</span> <span class="p">(</span><span class="nf">2</span> <span class="nv">?x</span><span class="p">)</span> <span class="p">(</span><span class="nf">3</span><span class="p">)))</span>
<span class="c1">;;; Starting a new problem </span>
<span class="p">(</span><span class="nf">Query</span> <span class="nv">Results:</span><span class="p">)</span>
<span class="c1">;;; Amb-Eval value:</span>
<span class="p">(</span><span class="nf">last-pair</span> <span class="p">(</span><span class="nf">2</span> <span class="mi">3</span><span class="p">)</span> <span class="p">(</span><span class="nf">3</span><span class="p">))</span></pre></td></tr></tbody></table></code></pre></figure>

<h3 id="complete-code-of-logic-evaluator">Complete code of logic evaluator</h3>

<figure class="highlight"><pre><code class="language-scheme" data-lang="scheme"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
459
460
461
462
463
464
465
466
467
468
469
470
471
472
473
474
475
476
477
478
479
480
481
482
483
484
485
486
487
488
489
490
491
492
493
494
495
496
497
498
499
500
501
502
503
504
505
506
507
508
509
510
511
512
513
514
515
516
517
518
519
520
521
522
523
524
525
526
527
528
529
530
531
532
533
534
535
536
537
538
539
540
541
542
543
544
545
546
547
548
549
</pre></td><td class="code"><pre><span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">lp</span> <span class="nv">query</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">q</span> <span class="p">(</span><span class="nf">query-syntax-process</span> <span class="nv">query</span><span class="p">)))</span>
	<span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">assertion-to-be-added?</span> <span class="nv">q</span><span class="p">)</span>
		<span class="p">(</span><span class="k">begin</span>
		  <span class="p">(</span><span class="nf">add-rule-or-assertion!</span> <span class="p">(</span><span class="nf">add-assertion-body</span> <span class="nv">q</span><span class="p">))</span>
		  <span class="p">(</span><span class="nb">display</span> <span class="s">"Assertion added to data base."</span><span class="p">))</span>
		<span class="p">(</span><span class="k">begin</span>
		  <span class="p">(</span><span class="nb">display</span> <span class="s">"Query Results:"</span><span class="p">)</span>
		  <span class="p">(</span><span class="nf">instantiate</span> <span class="nv">q</span>
					   <span class="p">(</span><span class="nf">qeval</span> <span class="nv">q</span> <span class="o">'</span><span class="p">())</span>
					   <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">v</span> <span class="nv">f</span><span class="p">)</span>
						 <span class="p">(</span><span class="nf">contract-question-mark</span> <span class="nv">v</span><span class="p">)))))))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="k">and</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">)</span>
  <span class="p">(</span><span class="k">if</span> <span class="nv">a</span>
	  <span class="p">(</span><span class="k">if</span> <span class="nv">b</span> <span class="nv">true</span> <span class="nv">false</span><span class="p">)</span>
	  <span class="nv">false</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="k">or</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">)</span>
  <span class="p">(</span><span class="k">if</span> <span class="nv">a</span>
	  <span class="nv">true</span>
	  <span class="p">(</span><span class="k">if</span> <span class="nv">b</span> <span class="nv">true</span> <span class="nv">false</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nb">not</span> <span class="nv">e</span><span class="p">)</span>
  <span class="p">(</span><span class="k">if</span> <span class="nv">e</span> <span class="nv">false</span> <span class="nv">true</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">an-element-of</span> <span class="nv">items</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">require</span> <span class="p">(</span><span class="nb">not</span> <span class="p">(</span><span class="nb">null?</span> <span class="nv">items</span><span class="p">)))</span>
  <span class="p">(</span><span class="nf">amb</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">items</span><span class="p">)</span> <span class="p">(</span><span class="nf">an-element-of</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">items</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">instantiate</span> <span class="nv">exp</span> <span class="nv">frame</span> <span class="nv">unbound-var-handler</span><span class="p">)</span>
  <span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">copy</span> <span class="nv">exp</span><span class="p">)</span>
    <span class="p">(</span><span class="k">cond</span> <span class="p">((</span><span class="nf">var?</span> <span class="nv">exp</span><span class="p">)</span>
           <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">binding</span> <span class="p">(</span><span class="nf">binding-in-frame</span> <span class="nv">exp</span> <span class="nv">frame</span><span class="p">)))</span>
             <span class="p">(</span><span class="k">if</span> <span class="nv">binding</span>
                 <span class="p">(</span><span class="nf">copy</span> <span class="p">(</span><span class="nf">binding-value</span> <span class="nv">binding</span><span class="p">))</span>
                 <span class="p">(</span><span class="nf">unbound-var-handler</span> <span class="nv">exp</span> <span class="nv">frame</span><span class="p">))))</span>
          <span class="p">((</span><span class="nb">pair?</span> <span class="nv">exp</span><span class="p">)</span>
           <span class="p">(</span><span class="nb">cons</span> <span class="p">(</span><span class="nf">copy</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">exp</span><span class="p">))</span> <span class="p">(</span><span class="nf">copy</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">exp</span><span class="p">))))</span>
          <span class="p">(</span><span class="k">else</span> <span class="nv">exp</span><span class="p">)))</span>
  <span class="p">(</span><span class="nf">copy</span> <span class="nv">exp</span><span class="p">))</span>

<span class="c1">;;;SECTION 4.4.4.2</span>
<span class="c1">;;;The Evaluator</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">qeval</span> <span class="nv">query</span> <span class="nv">frame</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">qproc</span> <span class="p">(</span><span class="nf">get</span> <span class="p">(</span><span class="nf">type</span> <span class="nv">query</span><span class="p">)</span> <span class="ss">'qeval</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">if</span> <span class="nv">qproc</span>
        <span class="p">(</span><span class="nf">qproc</span> <span class="p">(</span><span class="nf">contents</span> <span class="nv">query</span><span class="p">)</span> <span class="nv">frame</span><span class="p">)</span>
        <span class="p">(</span><span class="nf">simple-query</span> <span class="nv">query</span> <span class="nv">frame</span><span class="p">))))</span>

<span class="c1">;;;Simple queries</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">simple-query</span> <span class="nv">query-pattern</span> <span class="nv">frame</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">amb</span> <span class="p">(</span><span class="nf">find-assertions</span> <span class="nv">query-pattern</span> <span class="nv">frame</span><span class="p">)</span>
	   <span class="p">(</span><span class="nf">apply-rules</span> <span class="nv">query-pattern</span> <span class="nv">frame</span><span class="p">)))</span>

<span class="c1">;;;Compound queries</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">conjoin</span> <span class="nv">conjuncts</span> <span class="nv">frame</span><span class="p">)</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">empty-conjunction?</span> <span class="nv">conjuncts</span><span class="p">)</span>
      <span class="nv">frame</span>
      <span class="p">(</span><span class="nf">conjoin</span> <span class="p">(</span><span class="nf">rest-conjuncts</span> <span class="nv">conjuncts</span><span class="p">)</span>
               <span class="p">(</span><span class="nf">qeval</span> <span class="p">(</span><span class="nf">first-conjunct</span> <span class="nv">conjuncts</span><span class="p">)</span>
                      <span class="nv">frame</span><span class="p">))))</span>

<span class="c1">;;(put 'and 'qeval conjoin)</span>


<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">disjoin</span> <span class="nv">disjuncts</span> <span class="nv">frame</span><span class="p">)</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">empty-disjunction?</span> <span class="nv">disjuncts</span><span class="p">)</span>
	  <span class="p">(</span><span class="nf">amb</span><span class="p">)</span>
	  <span class="p">(</span><span class="nf">amb</span>
       <span class="p">(</span><span class="nf">qeval</span> <span class="p">(</span><span class="nf">first-disjunct</span> <span class="nv">disjuncts</span><span class="p">)</span> <span class="nv">frame</span><span class="p">)</span>
       <span class="p">(</span><span class="nf">disjoin</span> <span class="p">(</span><span class="nf">rest-disjuncts</span> <span class="nv">disjuncts</span><span class="p">)</span>
                       <span class="nv">frame</span><span class="p">))))</span>

<span class="c1">;;(put 'or 'qeval disjoin)</span>

<span class="c1">;;;Filters</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">negate</span> <span class="nv">operands</span> <span class="nv">frame</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">ensure-fail</span> <span class="p">(</span><span class="nf">qeval</span> <span class="p">(</span><span class="nf">negated-query</span> <span class="nv">operands</span><span class="p">)</span>
					  <span class="nv">frame</span><span class="p">))</span>
  <span class="nv">frame</span><span class="p">)</span>

<span class="c1">;;(put 'not 'qeval negate)</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">lisp-value</span> <span class="nv">call</span> <span class="nv">frame</span><span class="p">)</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">execute</span>
       <span class="p">(</span><span class="nf">instantiate</span>
        <span class="nv">call</span>
        <span class="nv">frame</span>
        <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">v</span> <span class="nv">f</span><span class="p">)</span>
          <span class="p">(</span><span class="nf">error</span> <span class="s">"Unknown pat var -- LISP-VALUE"</span> <span class="nv">v</span><span class="p">))))</span>
      <span class="nv">frame</span>
	  <span class="p">(</span><span class="nf">amb</span><span class="p">)))</span>

<span class="c1">;;(put 'lisp-value 'qeval lisp-value)</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">execute</span> <span class="nv">exp</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">apply</span> <span class="p">(</span><span class="nb">eval</span> <span class="p">(</span><span class="nf">predicate</span> <span class="nv">exp</span><span class="p">)</span> <span class="nv">user-initial-environment</span><span class="p">)</span>
         <span class="p">(</span><span class="nf">args</span> <span class="nv">exp</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">always-true</span> <span class="nv">ignore</span> <span class="nv">frame</span><span class="p">)</span> <span class="nv">frame</span><span class="p">)</span>

<span class="c1">;;(put 'always-true 'qeval always-true)</span>

<span class="c1">;;;SECTION 4.4.4.3</span>
<span class="c1">;;;Finding Assertions by Pattern Matching</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">find-assertions</span> <span class="nv">pattern</span> <span class="nv">frame</span><span class="p">)</span>
	<span class="p">(</span><span class="nf">pattern-match</span> <span class="nv">pattern</span>
				   <span class="p">(</span><span class="nf">an-element-of</span>
					<span class="p">(</span><span class="nf">fetch-assertions</span> <span class="nv">pattern</span> <span class="nv">frame</span><span class="p">))</span>
				   <span class="nv">frame</span><span class="p">))</span>

<span class="c1">;; (define (check-an-assertion assertion query-pat query-frame)</span>
<span class="c1">;;   (let ((match-result</span>
<span class="c1">;;          (pattern-match query-pat assertion query-frame)))</span>
<span class="c1">;;     (if (eq? match-result 'failed)</span>
<span class="c1">;;         the-empty-stream</span>
<span class="c1">;;         (singleton-stream match-result))))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">pattern-match</span> <span class="nv">pat</span> <span class="nv">dat</span> <span class="nv">frame</span><span class="p">)</span>
  <span class="p">(</span><span class="k">cond</span> <span class="p">((</span><span class="nb">equal?</span> <span class="nv">pat</span> <span class="nv">dat</span><span class="p">)</span> <span class="nv">frame</span><span class="p">)</span>
        <span class="p">((</span><span class="nf">var?</span> <span class="nv">pat</span><span class="p">)</span> <span class="p">(</span><span class="nf">extend-if-consistent</span> <span class="nv">pat</span> <span class="nv">dat</span> <span class="nv">frame</span><span class="p">))</span>
        <span class="p">((</span><span class="k">and</span> <span class="p">(</span><span class="nb">pair?</span> <span class="nv">pat</span><span class="p">)</span> <span class="p">(</span><span class="nb">pair?</span> <span class="nv">dat</span><span class="p">))</span>
         <span class="p">(</span><span class="nf">pattern-match</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">pat</span><span class="p">)</span>
                        <span class="p">(</span><span class="nb">cdr</span> <span class="nv">dat</span><span class="p">)</span>
                        <span class="p">(</span><span class="nf">pattern-match</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">pat</span><span class="p">)</span>
                                       <span class="p">(</span><span class="nb">car</span> <span class="nv">dat</span><span class="p">)</span>
                                       <span class="nv">frame</span><span class="p">)))</span>
        <span class="p">(</span><span class="k">else</span> <span class="p">(</span><span class="nf">amb</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">extend-if-consistent</span> <span class="nv">var</span> <span class="nv">dat</span> <span class="nv">frame</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">binding</span> <span class="p">(</span><span class="nf">binding-in-frame</span> <span class="nv">var</span> <span class="nv">frame</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">if</span> <span class="nv">binding</span>
        <span class="p">(</span><span class="nf">pattern-match</span> <span class="p">(</span><span class="nf">binding-value</span> <span class="nv">binding</span><span class="p">)</span> <span class="nv">dat</span> <span class="nv">frame</span><span class="p">)</span>
        <span class="p">(</span><span class="nf">extend</span> <span class="nv">var</span> <span class="nv">dat</span> <span class="nv">frame</span><span class="p">))))</span>

<span class="c1">;;;SECTION 4.4.4.4</span>
<span class="c1">;;;Rules and Unification</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">apply-rules</span> <span class="nv">pattern</span> <span class="nv">frame</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">apply-a-rule</span> <span class="p">(</span><span class="nf">an-element-of</span>
				 <span class="p">(</span><span class="nf">fetch-rules</span> <span class="nv">pattern</span> <span class="nv">frame</span><span class="p">))</span>
				<span class="nv">pattern</span>
				<span class="nv">frame</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">apply-a-rule</span> <span class="nv">rule</span> <span class="nv">query-pattern</span> <span class="nv">query-frame</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">clean-rule</span> <span class="p">(</span><span class="nf">rename-variables-in</span> <span class="nv">rule</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">unify-result</span>
           <span class="p">(</span><span class="nf">unify-match</span> <span class="nv">query-pattern</span>
                        <span class="p">(</span><span class="nf">conclusion</span> <span class="nv">clean-rule</span><span class="p">)</span>
                        <span class="nv">query-frame</span><span class="p">)))</span>
      <span class="p">(</span><span class="nf">qeval</span> <span class="p">(</span><span class="nf">rule-body</span> <span class="nv">clean-rule</span><span class="p">)</span>
              <span class="nv">unify-result</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">rename-variables-in</span> <span class="nv">rule</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">rule-application-id</span> <span class="p">(</span><span class="nf">new-rule-application-id</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">tree-walk</span> <span class="nv">exp</span><span class="p">)</span>
      <span class="p">(</span><span class="k">cond</span> <span class="p">((</span><span class="nf">var?</span> <span class="nv">exp</span><span class="p">)</span>
             <span class="p">(</span><span class="nf">make-new-variable</span> <span class="nv">exp</span> <span class="nv">rule-application-id</span><span class="p">))</span>
            <span class="p">((</span><span class="nb">pair?</span> <span class="nv">exp</span><span class="p">)</span>
             <span class="p">(</span><span class="nb">cons</span> <span class="p">(</span><span class="nf">tree-walk</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">exp</span><span class="p">))</span>
                   <span class="p">(</span><span class="nf">tree-walk</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">exp</span><span class="p">))))</span>
            <span class="p">(</span><span class="k">else</span> <span class="nv">exp</span><span class="p">)))</span>
    <span class="p">(</span><span class="nf">tree-walk</span> <span class="nv">rule</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">unify-match</span> <span class="nv">p1</span> <span class="nv">p2</span> <span class="nv">frame</span><span class="p">)</span>
  <span class="p">(</span><span class="k">cond</span> <span class="p">((</span><span class="nb">equal?</span> <span class="nv">p1</span> <span class="nv">p2</span><span class="p">)</span> <span class="nv">frame</span><span class="p">)</span>
        <span class="p">((</span><span class="nf">var?</span> <span class="nv">p1</span><span class="p">)</span> <span class="p">(</span><span class="nf">extend-if-possible</span> <span class="nv">p1</span> <span class="nv">p2</span> <span class="nv">frame</span><span class="p">))</span>
        <span class="p">((</span><span class="nf">var?</span> <span class="nv">p2</span><span class="p">)</span> <span class="p">(</span><span class="nf">extend-if-possible</span> <span class="nv">p2</span> <span class="nv">p1</span> <span class="nv">frame</span><span class="p">))</span> <span class="c1">; {\em ; ***}</span>
        <span class="p">((</span><span class="k">and</span> <span class="p">(</span><span class="nb">pair?</span> <span class="nv">p1</span><span class="p">)</span> <span class="p">(</span><span class="nb">pair?</span> <span class="nv">p2</span><span class="p">))</span>
         <span class="p">(</span><span class="nf">unify-match</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">p1</span><span class="p">)</span>
                      <span class="p">(</span><span class="nb">cdr</span> <span class="nv">p2</span><span class="p">)</span>
                      <span class="p">(</span><span class="nf">unify-match</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">p1</span><span class="p">)</span>
                                   <span class="p">(</span><span class="nb">car</span> <span class="nv">p2</span><span class="p">)</span>
                                   <span class="nv">frame</span><span class="p">)))</span>
        <span class="p">(</span><span class="k">else</span> <span class="p">(</span><span class="nf">amb</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">extend-if-possible</span> <span class="nv">var</span> <span class="nv">val</span> <span class="nv">frame</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">binding</span> <span class="p">(</span><span class="nf">binding-in-frame</span> <span class="nv">var</span> <span class="nv">frame</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">cond</span> <span class="p">(</span><span class="nf">binding</span>
           <span class="p">(</span><span class="nf">unify-match</span>
            <span class="p">(</span><span class="nf">binding-value</span> <span class="nv">binding</span><span class="p">)</span> <span class="nv">val</span> <span class="nv">frame</span><span class="p">))</span>
          <span class="p">((</span><span class="nf">var?</span> <span class="nv">val</span><span class="p">)</span>                     <span class="c1">; {\em ; ***}</span>
           <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">binding</span> <span class="p">(</span><span class="nf">binding-in-frame</span> <span class="nv">val</span> <span class="nv">frame</span><span class="p">)))</span>
             <span class="p">(</span><span class="k">if</span> <span class="nv">binding</span>
                 <span class="p">(</span><span class="nf">unify-match</span>
                  <span class="nv">var</span> <span class="p">(</span><span class="nf">binding-value</span> <span class="nv">binding</span><span class="p">)</span> <span class="nv">frame</span><span class="p">)</span>
                 <span class="p">(</span><span class="nf">extend</span> <span class="nv">var</span> <span class="nv">val</span> <span class="nv">frame</span><span class="p">))))</span>
          <span class="p">((</span><span class="nf">depends-on?</span> <span class="nv">val</span> <span class="nv">var</span> <span class="nv">frame</span><span class="p">)</span>    <span class="c1">; {\em ; ***}</span>
           <span class="p">(</span><span class="nf">amb</span><span class="p">))</span>
          <span class="p">(</span><span class="k">else</span> <span class="p">(</span><span class="nf">extend</span> <span class="nv">var</span> <span class="nv">val</span> <span class="nv">frame</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">depends-on?</span> <span class="nv">exp</span> <span class="nv">var</span> <span class="nv">frame</span><span class="p">)</span>
  <span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">tree-walk</span> <span class="nv">e</span><span class="p">)</span>
    <span class="p">(</span><span class="k">cond</span> <span class="p">((</span><span class="nf">var?</span> <span class="nv">e</span><span class="p">)</span>
           <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">equal?</span> <span class="nv">var</span> <span class="nv">e</span><span class="p">)</span>
               <span class="nv">true</span>
               <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">b</span> <span class="p">(</span><span class="nf">binding-in-frame</span> <span class="nv">e</span> <span class="nv">frame</span><span class="p">)))</span>
                 <span class="p">(</span><span class="k">if</span> <span class="nv">b</span>
                     <span class="p">(</span><span class="nf">tree-walk</span> <span class="p">(</span><span class="nf">binding-value</span> <span class="nv">b</span><span class="p">))</span>
                     <span class="nv">false</span><span class="p">))))</span>
          <span class="p">((</span><span class="nb">pair?</span> <span class="nv">e</span><span class="p">)</span>
           <span class="p">(</span><span class="k">or</span> <span class="p">(</span><span class="nf">tree-walk</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">e</span><span class="p">))</span>
               <span class="p">(</span><span class="nf">tree-walk</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">e</span><span class="p">))))</span>
          <span class="p">(</span><span class="k">else</span> <span class="nv">false</span><span class="p">)))</span>
  <span class="p">(</span><span class="nf">tree-walk</span> <span class="nv">exp</span><span class="p">))</span>

<span class="c1">;;;SECTION 4.4.4.5</span>
<span class="c1">;;;Maintaining the Data Base</span>

<span class="p">(</span><span class="k">define</span> <span class="nv">THE-ASSERTIONS</span> <span class="o">'</span><span class="p">())</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">fetch-assertions</span> <span class="nv">pattern</span> <span class="nv">frame</span><span class="p">)</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">use-index?</span> <span class="nv">pattern</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">get-indexed-assertions</span> <span class="nv">pattern</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">get-all-assertions</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">get-all-assertions</span><span class="p">)</span> <span class="nv">THE-ASSERTIONS</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">get-indexed-assertions</span> <span class="nv">pattern</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">get-list</span> <span class="p">(</span><span class="nf">index-key-of</span> <span class="nv">pattern</span><span class="p">)</span> <span class="ss">'assertion-list</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">get-list</span> <span class="nv">key1</span> <span class="nv">key2</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">s</span> <span class="p">(</span><span class="nf">get</span> <span class="nv">key1</span> <span class="nv">key2</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">if</span> <span class="nv">s</span> <span class="nv">s</span> <span class="o">'</span><span class="p">())))</span>

<span class="p">(</span><span class="k">define</span> <span class="nv">THE-RULES</span> <span class="o">'</span><span class="p">())</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">fetch-rules</span> <span class="nv">pattern</span> <span class="nv">frame</span><span class="p">)</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">use-index?</span> <span class="nv">pattern</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">get-indexed-rules</span> <span class="nv">pattern</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">get-all-rules</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">get-all-rules</span><span class="p">)</span> <span class="nv">THE-RULES</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">get-indexed-rules</span> <span class="nv">pattern</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">append</span>
   <span class="p">(</span><span class="nf">get-list</span> <span class="p">(</span><span class="nf">index-key-of</span> <span class="nv">pattern</span><span class="p">)</span> <span class="ss">'rule-list</span><span class="p">)</span>
   <span class="p">(</span><span class="nf">get-list</span> <span class="ss">'?</span> <span class="ss">'rule-list</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">add-rule-or-assertion!</span> <span class="nv">assertion</span><span class="p">)</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">rule?</span> <span class="nv">assertion</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">add-rule!</span> <span class="nv">assertion</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">add-assertion!</span> <span class="nv">assertion</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">add-assertion!</span> <span class="nv">assertion</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">store-assertion-in-index</span> <span class="nv">assertion</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">old-assertions</span> <span class="nv">THE-ASSERTIONS</span><span class="p">))</span>
    <span class="p">(</span><span class="k">set!</span> <span class="nv">THE-ASSERTIONS</span>
          <span class="p">(</span><span class="nb">cons</span> <span class="nv">assertion</span> <span class="nv">old-assertions</span><span class="p">))</span>
    <span class="ss">'ok</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">add-rule!</span> <span class="nv">rule</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">store-rule-in-index</span> <span class="nv">rule</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">old-rules</span> <span class="nv">THE-RULES</span><span class="p">))</span>
    <span class="p">(</span><span class="k">set!</span> <span class="nv">THE-RULES</span> <span class="p">(</span><span class="nb">cons</span> <span class="nv">rule</span> <span class="nv">old-rules</span><span class="p">))</span>
    <span class="ss">'ok</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">store-assertion-in-index</span> <span class="nv">assertion</span><span class="p">)</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">indexable?</span> <span class="nv">assertion</span><span class="p">)</span>
      <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">key</span> <span class="p">(</span><span class="nf">index-key-of</span> <span class="nv">assertion</span><span class="p">)))</span>
        <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">current-assertion-list</span>
               <span class="p">(</span><span class="nf">get-list</span> <span class="nv">key</span> <span class="ss">'assertion-list</span><span class="p">)))</span>
          <span class="p">(</span><span class="nf">put</span> <span class="nv">key</span>
               <span class="ss">'assertion-list</span>
               <span class="p">(</span><span class="nb">cons</span> <span class="nv">assertion</span>
                            <span class="nv">current-assertion-list</span><span class="p">))))))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">store-rule-in-index</span> <span class="nv">rule</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">pattern</span> <span class="p">(</span><span class="nf">conclusion</span> <span class="nv">rule</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">indexable?</span> <span class="nv">pattern</span><span class="p">)</span>
        <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">key</span> <span class="p">(</span><span class="nf">index-key-of</span> <span class="nv">pattern</span><span class="p">)))</span>
          <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">current-rule-list</span>
                 <span class="p">(</span><span class="nf">get-list</span> <span class="nv">key</span> <span class="ss">'rule-list</span><span class="p">)))</span>
            <span class="p">(</span><span class="nf">put</span> <span class="nv">key</span>
                 <span class="ss">'rule-list</span>
                 <span class="p">(</span><span class="nb">cons</span> <span class="nv">rule</span>
                              <span class="nv">current-rule-list</span><span class="p">)))))))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">indexable?</span> <span class="nv">pat</span><span class="p">)</span>
  <span class="p">(</span><span class="k">or</span> <span class="p">(</span><span class="nf">constant-symbol?</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">pat</span><span class="p">))</span>
      <span class="p">(</span><span class="nf">var?</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">pat</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">index-key-of</span> <span class="nv">pat</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">key</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">pat</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">var?</span> <span class="nv">key</span><span class="p">)</span> <span class="ss">'?</span> <span class="nv">key</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">use-index?</span> <span class="nv">pat</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">constant-symbol?</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">pat</span><span class="p">)))</span>

<span class="c1">;;;SECTION 4.4.4.7</span>
<span class="c1">;;;Query syntax procedures</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">type</span> <span class="nv">exp</span><span class="p">)</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">pair?</span> <span class="nv">exp</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">car</span> <span class="nv">exp</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">error</span> <span class="s">"Unknown expression TYPE"</span> <span class="nv">exp</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">contents</span> <span class="nv">exp</span><span class="p">)</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">pair?</span> <span class="nv">exp</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">cdr</span> <span class="nv">exp</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">error</span> <span class="s">"Unknown expression CONTENTS"</span> <span class="nv">exp</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">assertion-to-be-added?</span> <span class="nv">exp</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">eq?</span> <span class="p">(</span><span class="nf">type</span> <span class="nv">exp</span><span class="p">)</span> <span class="ss">'assert!</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">add-assertion-body</span> <span class="nv">exp</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">car</span> <span class="p">(</span><span class="nf">contents</span> <span class="nv">exp</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">empty-conjunction?</span> <span class="nv">exps</span><span class="p">)</span> <span class="p">(</span><span class="nb">null?</span> <span class="nv">exps</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">first-conjunct</span> <span class="nv">exps</span><span class="p">)</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">exps</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">rest-conjuncts</span> <span class="nv">exps</span><span class="p">)</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">exps</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">empty-disjunction?</span> <span class="nv">exps</span><span class="p">)</span> <span class="p">(</span><span class="nb">null?</span> <span class="nv">exps</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">first-disjunct</span> <span class="nv">exps</span><span class="p">)</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">exps</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">rest-disjuncts</span> <span class="nv">exps</span><span class="p">)</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">exps</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">negated-query</span> <span class="nv">exps</span><span class="p">)</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">exps</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">predicate</span> <span class="nv">exps</span><span class="p">)</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">exps</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">args</span> <span class="nv">exps</span><span class="p">)</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">exps</span><span class="p">))</span>


<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">rule?</span> <span class="nv">statement</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">tagged-list?</span> <span class="nv">statement</span> <span class="ss">'rule</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">conclusion</span> <span class="nv">rule</span><span class="p">)</span> <span class="p">(</span><span class="nb">cadr</span> <span class="nv">rule</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">rule-body</span> <span class="nv">rule</span><span class="p">)</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">null?</span> <span class="p">(</span><span class="nb">cddr</span> <span class="nv">rule</span><span class="p">))</span>
      <span class="o">'</span><span class="p">(</span><span class="nf">always-true</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">caddr</span> <span class="nv">rule</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">query-syntax-process</span> <span class="nv">exp</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">map-over-symbols</span> <span class="nv">expand-question-mark</span> <span class="nv">exp</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">map-over-symbols</span> <span class="nv">proc</span> <span class="nv">exp</span><span class="p">)</span>
  <span class="p">(</span><span class="k">cond</span> <span class="p">((</span><span class="nb">pair?</span> <span class="nv">exp</span><span class="p">)</span>
         <span class="p">(</span><span class="nb">cons</span> <span class="p">(</span><span class="nf">map-over-symbols</span> <span class="nv">proc</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">exp</span><span class="p">))</span>
               <span class="p">(</span><span class="nf">map-over-symbols</span> <span class="nv">proc</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">exp</span><span class="p">))))</span>
        <span class="p">((</span><span class="nb">symbol?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nf">proc</span> <span class="nv">exp</span><span class="p">))</span>
        <span class="p">(</span><span class="k">else</span> <span class="nv">exp</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">expand-question-mark</span> <span class="nv">symbol</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">chars</span> <span class="p">(</span><span class="nb">symbol-&gt;string</span> <span class="nv">symbol</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">string=?</span> <span class="p">(</span><span class="nb">substring</span> <span class="nv">chars</span> <span class="mi">0</span> <span class="mi">1</span><span class="p">)</span> <span class="s">"?"</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'?</span>
              <span class="p">(</span><span class="nb">string-&gt;symbol</span>
               <span class="p">(</span><span class="nb">substring</span> <span class="nv">chars</span> <span class="mi">1</span> <span class="p">(</span><span class="nb">string-length</span> <span class="nv">chars</span><span class="p">))))</span>
        <span class="nv">symbol</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">var?</span> <span class="nv">exp</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">tagged-list?</span> <span class="nv">exp</span> <span class="ss">'?</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">constant-symbol?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nb">symbol?</span> <span class="nv">exp</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span> <span class="nv">rule-counter</span> <span class="mi">0</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">new-rule-application-id</span><span class="p">)</span>
  <span class="p">(</span><span class="k">set!</span> <span class="nv">rule-counter</span> <span class="p">(</span><span class="nb">+</span> <span class="mi">1</span> <span class="nv">rule-counter</span><span class="p">))</span>
  <span class="nv">rule-counter</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">make-new-variable</span> <span class="nv">var</span> <span class="nv">rule-application-id</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">cons</span> <span class="ss">'?</span> <span class="p">(</span><span class="nb">cons</span> <span class="nv">rule-application-id</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">var</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">contract-question-mark</span> <span class="nv">variable</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">string-&gt;symbol</span>
   <span class="p">(</span><span class="nb">string-append</span> <span class="s">"?"</span> 
     <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">number?</span> <span class="p">(</span><span class="nb">cadr</span> <span class="nv">variable</span><span class="p">))</span>
         <span class="p">(</span><span class="nb">string-append</span> <span class="p">(</span><span class="nb">symbol-&gt;string</span> <span class="p">(</span><span class="nb">caddr</span> <span class="nv">variable</span><span class="p">))</span>
                        <span class="s">"-"</span>
                        <span class="p">(</span><span class="nb">number-&gt;string</span> <span class="p">(</span><span class="nb">cadr</span> <span class="nv">variable</span><span class="p">)))</span>
         <span class="p">(</span><span class="nb">symbol-&gt;string</span> <span class="p">(</span><span class="nb">cadr</span> <span class="nv">variable</span><span class="p">))))))</span>


<span class="c1">;;;SECTION 4.4.4.8</span>
<span class="c1">;;;Frames and bindings</span>
<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">make-binding</span> <span class="nv">variable</span> <span class="nv">value</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">cons</span> <span class="nv">variable</span> <span class="nv">value</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">binding-variable</span> <span class="nv">binding</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">car</span> <span class="nv">binding</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">binding-value</span> <span class="nv">binding</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">cdr</span> <span class="nv">binding</span><span class="p">))</span>


<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">binding-in-frame</span> <span class="nv">variable</span> <span class="nv">frame</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">assoc</span> <span class="nv">variable</span> <span class="nv">frame</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">extend</span> <span class="nv">variable</span> <span class="nv">value</span> <span class="nv">frame</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">cons</span> <span class="p">(</span><span class="nf">make-binding</span> <span class="nv">variable</span> <span class="nv">value</span><span class="p">)</span> <span class="nv">frame</span><span class="p">))</span>


<span class="c1">;;;;From Section 4.1</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">tagged-list?</span> <span class="nv">exp</span> <span class="nv">tag</span><span class="p">)</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">pair?</span> <span class="nv">exp</span><span class="p">)</span>
      <span class="p">(</span><span class="nb">eq?</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">exp</span><span class="p">)</span> <span class="nv">tag</span><span class="p">)</span>
      <span class="nv">false</span><span class="p">))</span>

<span class="c1">;;;;Table support from Chapter 3, Section 3.3.3 (local tables)</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">make-table</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">local-table</span> <span class="p">(</span><span class="nb">list</span> <span class="ss">'*table*</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">lookup</span> <span class="nv">key-1</span> <span class="nv">key-2</span><span class="p">)</span>
      <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">subtable</span> <span class="p">(</span><span class="nb">assoc</span> <span class="nv">key-1</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">local-table</span><span class="p">))))</span>
        <span class="p">(</span><span class="k">if</span> <span class="nv">subtable</span>
            <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">record</span> <span class="p">(</span><span class="nb">assoc</span> <span class="nv">key-2</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">subtable</span><span class="p">))))</span>
              <span class="p">(</span><span class="k">if</span> <span class="nv">record</span>
                  <span class="p">(</span><span class="nb">cdr</span> <span class="nv">record</span><span class="p">)</span>
                  <span class="nv">false</span><span class="p">))</span>
            <span class="nv">false</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">insert!</span> <span class="nv">key-1</span> <span class="nv">key-2</span> <span class="nv">value</span><span class="p">)</span>
      <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">subtable</span> <span class="p">(</span><span class="nb">assoc</span> <span class="nv">key-1</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">local-table</span><span class="p">))))</span>
        <span class="p">(</span><span class="k">if</span> <span class="nv">subtable</span>
            <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">record</span> <span class="p">(</span><span class="nb">assoc</span> <span class="nv">key-2</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">subtable</span><span class="p">))))</span>
              <span class="p">(</span><span class="k">if</span> <span class="nv">record</span>
                  <span class="p">(</span><span class="nb">set-cdr!</span> <span class="nv">record</span> <span class="nv">value</span><span class="p">)</span>
                  <span class="p">(</span><span class="nb">set-cdr!</span> <span class="nv">subtable</span>
                            <span class="p">(</span><span class="nb">cons</span> <span class="p">(</span><span class="nb">cons</span> <span class="nv">key-2</span> <span class="nv">value</span><span class="p">)</span>
                                  <span class="p">(</span><span class="nb">cdr</span> <span class="nv">subtable</span><span class="p">)))))</span>
            <span class="p">(</span><span class="nb">set-cdr!</span> <span class="nv">local-table</span>
                      <span class="p">(</span><span class="nb">cons</span> <span class="p">(</span><span class="nb">list</span> <span class="nv">key-1</span>
                                  <span class="p">(</span><span class="nb">cons</span> <span class="nv">key-2</span> <span class="nv">value</span><span class="p">))</span>
                            <span class="p">(</span><span class="nb">cdr</span> <span class="nv">local-table</span><span class="p">)))))</span>
      <span class="ss">'ok</span><span class="p">)</span>    
    <span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">dispatch</span> <span class="nv">m</span><span class="p">)</span>
      <span class="p">(</span><span class="k">cond</span> <span class="p">((</span><span class="nb">eq?</span> <span class="nv">m</span> <span class="ss">'lookup-proc</span><span class="p">)</span> <span class="nv">lookup</span><span class="p">)</span>
            <span class="p">((</span><span class="nb">eq?</span> <span class="nv">m</span> <span class="ss">'insert-proc!</span><span class="p">)</span> <span class="nv">insert!</span><span class="p">)</span>
            <span class="p">(</span><span class="k">else</span> <span class="p">(</span><span class="nf">error</span> <span class="s">"Unknown operation -- TABLE"</span> <span class="nv">m</span><span class="p">))))</span>
    <span class="nv">dispatch</span><span class="p">))</span>

<span class="c1">;;;; From instructor's manual</span>

<span class="p">(</span><span class="k">define</span> <span class="nv">get</span> <span class="o">'</span><span class="p">())</span>

<span class="p">(</span><span class="k">define</span> <span class="nv">put</span> <span class="o">'</span><span class="p">())</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">initialize-data-base</span> <span class="nv">rules-and-assertions</span><span class="p">)</span>
  <span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">deal-out</span> <span class="nv">r-and-a</span> <span class="nv">rules</span> <span class="nv">assertions</span><span class="p">)</span>
    <span class="p">(</span><span class="k">cond</span> <span class="p">((</span><span class="nb">null?</span> <span class="nv">r-and-a</span><span class="p">)</span>
           <span class="p">(</span><span class="k">set!</span> <span class="nv">THE-ASSERTIONS</span> <span class="nv">assertions</span><span class="p">)</span>
           <span class="p">(</span><span class="k">set!</span> <span class="nv">THE-RULES</span> <span class="nv">rules</span><span class="p">)</span>
           <span class="ss">'done</span><span class="p">)</span>
          <span class="p">(</span><span class="k">else</span>
           <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">s</span> <span class="p">(</span><span class="nf">query-syntax-process</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">r-and-a</span><span class="p">))))</span>
             <span class="p">(</span><span class="k">cond</span> <span class="p">((</span><span class="nf">rule?</span> <span class="nv">s</span><span class="p">)</span>
                    <span class="p">(</span><span class="nf">store-rule-in-index</span> <span class="nv">s</span><span class="p">)</span>
                    <span class="p">(</span><span class="nf">deal-out</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">r-and-a</span><span class="p">)</span>
                              <span class="p">(</span><span class="nb">cons</span> <span class="nv">s</span> <span class="nv">rules</span><span class="p">)</span>
                              <span class="nv">assertions</span><span class="p">))</span>
                   <span class="p">(</span><span class="k">else</span>
                    <span class="p">(</span><span class="nf">store-assertion-in-index</span> <span class="nv">s</span><span class="p">)</span>
                    <span class="p">(</span><span class="nf">deal-out</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">r-and-a</span><span class="p">)</span>
                              <span class="nv">rules</span>
                              <span class="p">(</span><span class="nb">cons</span> <span class="nv">s</span> <span class="nv">assertions</span><span class="p">))))))))</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">operation-table</span> <span class="p">(</span><span class="nf">make-table</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">set!</span> <span class="nv">get</span> <span class="p">(</span><span class="nf">operation-table</span> <span class="ss">'lookup-proc</span><span class="p">))</span>
    <span class="p">(</span><span class="k">set!</span> <span class="nv">put</span> <span class="p">(</span><span class="nf">operation-table</span> <span class="ss">'insert-proc!</span><span class="p">)))</span>
  <span class="p">(</span><span class="nf">put</span> <span class="ss">'and</span> <span class="ss">'qeval</span> <span class="nv">conjoin</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">put</span> <span class="ss">'or</span> <span class="ss">'qeval</span> <span class="nv">disjoin</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">put</span> <span class="ss">'not</span> <span class="ss">'qeval</span> <span class="nv">negate</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">put</span> <span class="ss">'lisp-value</span> <span class="ss">'qeval</span> <span class="nv">lisp-value</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">put</span> <span class="ss">'always-true</span> <span class="ss">'qeval</span> <span class="nv">always-true</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">deal-out</span> <span class="nv">rules-and-assertions</span> <span class="o">'</span><span class="p">()</span> <span class="o">'</span><span class="p">()))</span>

<span class="c1">;; Do following to reinit the data base from microshaft-data-base</span>
<span class="c1">;;  in Scheme (not in the query driver loop)</span>
<span class="c1">;; (initialize-data-base microshaft-data-base)</span>

<span class="p">(</span><span class="k">define</span> <span class="nv">microshaft-data-base</span>
  <span class="o">'</span><span class="p">(</span>
<span class="c1">;; from section 4.4.1</span>
<span class="p">(</span><span class="nf">address</span> <span class="p">(</span><span class="nf">Bitdiddle</span> <span class="nv">Ben</span><span class="p">)</span> <span class="p">(</span><span class="nf">Slumerville</span> <span class="p">(</span><span class="nf">Ridge</span> <span class="nv">Road</span><span class="p">)</span> <span class="mi">10</span><span class="p">))</span>
<span class="p">(</span><span class="nf">job</span> <span class="p">(</span><span class="nf">Bitdiddle</span> <span class="nv">Ben</span><span class="p">)</span> <span class="p">(</span><span class="nf">computer</span> <span class="nv">wizard</span><span class="p">))</span>
<span class="p">(</span><span class="nf">salary</span> <span class="p">(</span><span class="nf">Bitdiddle</span> <span class="nv">Ben</span><span class="p">)</span> <span class="mi">60000</span><span class="p">)</span>

<span class="p">(</span><span class="nf">address</span> <span class="p">(</span><span class="nf">Hacker</span> <span class="nv">Alyssa</span> <span class="nv">P</span><span class="p">)</span> <span class="p">(</span><span class="nf">Cambridge</span> <span class="p">(</span><span class="nf">Mass</span> <span class="nv">Ave</span><span class="p">)</span> <span class="mi">78</span><span class="p">))</span>
<span class="p">(</span><span class="nf">job</span> <span class="p">(</span><span class="nf">Hacker</span> <span class="nv">Alyssa</span> <span class="nv">P</span><span class="p">)</span> <span class="p">(</span><span class="nf">computer</span> <span class="nv">programmer</span><span class="p">))</span>
<span class="p">(</span><span class="nf">salary</span> <span class="p">(</span><span class="nf">Hacker</span> <span class="nv">Alyssa</span> <span class="nv">P</span><span class="p">)</span> <span class="mi">40000</span><span class="p">)</span>
<span class="p">(</span><span class="nf">supervisor</span> <span class="p">(</span><span class="nf">Hacker</span> <span class="nv">Alyssa</span> <span class="nv">P</span><span class="p">)</span> <span class="p">(</span><span class="nf">Bitdiddle</span> <span class="nv">Ben</span><span class="p">))</span>

<span class="p">(</span><span class="nf">address</span> <span class="p">(</span><span class="nf">Fect</span> <span class="nv">Cy</span> <span class="nv">D</span><span class="p">)</span> <span class="p">(</span><span class="nf">Cambridge</span> <span class="p">(</span><span class="nf">Ames</span> <span class="nv">Street</span><span class="p">)</span> <span class="mi">3</span><span class="p">))</span>
<span class="p">(</span><span class="nf">job</span> <span class="p">(</span><span class="nf">Fect</span> <span class="nv">Cy</span> <span class="nv">D</span><span class="p">)</span> <span class="p">(</span><span class="nf">computer</span> <span class="nv">programmer</span><span class="p">))</span>
<span class="p">(</span><span class="nf">salary</span> <span class="p">(</span><span class="nf">Fect</span> <span class="nv">Cy</span> <span class="nv">D</span><span class="p">)</span> <span class="mi">35000</span><span class="p">)</span>
<span class="p">(</span><span class="nf">supervisor</span> <span class="p">(</span><span class="nf">Fect</span> <span class="nv">Cy</span> <span class="nv">D</span><span class="p">)</span> <span class="p">(</span><span class="nf">Bitdiddle</span> <span class="nv">Ben</span><span class="p">))</span>

<span class="p">(</span><span class="nf">address</span> <span class="p">(</span><span class="nf">Tweakit</span> <span class="nv">Lem</span> <span class="nv">E</span><span class="p">)</span> <span class="p">(</span><span class="nf">Boston</span> <span class="p">(</span><span class="nf">Bay</span> <span class="nv">State</span> <span class="nv">Road</span><span class="p">)</span> <span class="mi">22</span><span class="p">))</span>
<span class="p">(</span><span class="nf">job</span> <span class="p">(</span><span class="nf">Tweakit</span> <span class="nv">Lem</span> <span class="nv">E</span><span class="p">)</span> <span class="p">(</span><span class="nf">computer</span> <span class="nv">technician</span><span class="p">))</span>
<span class="p">(</span><span class="nf">salary</span> <span class="p">(</span><span class="nf">Tweakit</span> <span class="nv">Lem</span> <span class="nv">E</span><span class="p">)</span> <span class="mi">25000</span><span class="p">)</span>
<span class="p">(</span><span class="nf">supervisor</span> <span class="p">(</span><span class="nf">Tweakit</span> <span class="nv">Lem</span> <span class="nv">E</span><span class="p">)</span> <span class="p">(</span><span class="nf">Bitdiddle</span> <span class="nv">Ben</span><span class="p">))</span>

<span class="p">(</span><span class="nf">address</span> <span class="p">(</span><span class="nf">Reasoner</span> <span class="nv">Louis</span><span class="p">)</span> <span class="p">(</span><span class="nf">Slumerville</span> <span class="p">(</span><span class="nf">Pine</span> <span class="nv">Tree</span> <span class="nv">Road</span><span class="p">)</span> <span class="mi">80</span><span class="p">))</span>
<span class="p">(</span><span class="nf">job</span> <span class="p">(</span><span class="nf">Reasoner</span> <span class="nv">Louis</span><span class="p">)</span> <span class="p">(</span><span class="nf">computer</span> <span class="nv">programmer</span> <span class="nv">trainee</span><span class="p">))</span>
<span class="p">(</span><span class="nf">salary</span> <span class="p">(</span><span class="nf">Reasoner</span> <span class="nv">Louis</span><span class="p">)</span> <span class="mi">30000</span><span class="p">)</span>
<span class="p">(</span><span class="nf">supervisor</span> <span class="p">(</span><span class="nf">Reasoner</span> <span class="nv">Louis</span><span class="p">)</span> <span class="p">(</span><span class="nf">Hacker</span> <span class="nv">Alyssa</span> <span class="nv">P</span><span class="p">))</span>

<span class="p">(</span><span class="nf">supervisor</span> <span class="p">(</span><span class="nf">Bitdiddle</span> <span class="nv">Ben</span><span class="p">)</span> <span class="p">(</span><span class="nf">Warbucks</span> <span class="nv">Oliver</span><span class="p">))</span>

<span class="p">(</span><span class="nf">address</span> <span class="p">(</span><span class="nf">Warbucks</span> <span class="nv">Oliver</span><span class="p">)</span> <span class="p">(</span><span class="nf">Swellesley</span> <span class="p">(</span><span class="nf">Top</span> <span class="nv">Heap</span> <span class="nv">Road</span><span class="p">)))</span>
<span class="p">(</span><span class="nf">job</span> <span class="p">(</span><span class="nf">Warbucks</span> <span class="nv">Oliver</span><span class="p">)</span> <span class="p">(</span><span class="nf">administration</span> <span class="nv">big</span> <span class="nv">wheel</span><span class="p">))</span>
<span class="p">(</span><span class="nf">salary</span> <span class="p">(</span><span class="nf">Warbucks</span> <span class="nv">Oliver</span><span class="p">)</span> <span class="mi">150000</span><span class="p">)</span>

<span class="p">(</span><span class="nf">address</span> <span class="p">(</span><span class="nf">Scrooge</span> <span class="nv">Eben</span><span class="p">)</span> <span class="p">(</span><span class="nf">Weston</span> <span class="p">(</span><span class="nf">Shady</span> <span class="nv">Lane</span><span class="p">)</span> <span class="mi">10</span><span class="p">))</span>
<span class="p">(</span><span class="nf">job</span> <span class="p">(</span><span class="nf">Scrooge</span> <span class="nv">Eben</span><span class="p">)</span> <span class="p">(</span><span class="nf">accounting</span> <span class="nv">chief</span> <span class="nv">accountant</span><span class="p">))</span>
<span class="p">(</span><span class="nf">salary</span> <span class="p">(</span><span class="nf">Scrooge</span> <span class="nv">Eben</span><span class="p">)</span> <span class="mi">75000</span><span class="p">)</span>
<span class="p">(</span><span class="nf">supervisor</span> <span class="p">(</span><span class="nf">Scrooge</span> <span class="nv">Eben</span><span class="p">)</span> <span class="p">(</span><span class="nf">Warbucks</span> <span class="nv">Oliver</span><span class="p">))</span>

<span class="p">(</span><span class="nf">address</span> <span class="p">(</span><span class="nf">Cratchet</span> <span class="nv">Robert</span><span class="p">)</span> <span class="p">(</span><span class="nf">Allston</span> <span class="p">(</span><span class="nf">N</span> <span class="nv">Harvard</span> <span class="nv">Street</span><span class="p">)</span> <span class="mi">16</span><span class="p">))</span>
<span class="p">(</span><span class="nf">job</span> <span class="p">(</span><span class="nf">Cratchet</span> <span class="nv">Robert</span><span class="p">)</span> <span class="p">(</span><span class="nf">accounting</span> <span class="nv">scrivener</span><span class="p">))</span>
<span class="p">(</span><span class="nf">salary</span> <span class="p">(</span><span class="nf">Cratchet</span> <span class="nv">Robert</span><span class="p">)</span> <span class="mi">18000</span><span class="p">)</span>
<span class="p">(</span><span class="nf">supervisor</span> <span class="p">(</span><span class="nf">Cratchet</span> <span class="nv">Robert</span><span class="p">)</span> <span class="p">(</span><span class="nf">Scrooge</span> <span class="nv">Eben</span><span class="p">))</span>

<span class="p">(</span><span class="nf">address</span> <span class="p">(</span><span class="nf">Aull</span> <span class="nv">DeWitt</span><span class="p">)</span> <span class="p">(</span><span class="nf">Slumerville</span> <span class="p">(</span><span class="nf">Onion</span> <span class="nv">Square</span><span class="p">)</span> <span class="mi">5</span><span class="p">))</span>
<span class="p">(</span><span class="nf">job</span> <span class="p">(</span><span class="nf">Aull</span> <span class="nv">DeWitt</span><span class="p">)</span> <span class="p">(</span><span class="nf">administration</span> <span class="nv">secretary</span><span class="p">))</span>
<span class="p">(</span><span class="nf">salary</span> <span class="p">(</span><span class="nf">Aull</span> <span class="nv">DeWitt</span><span class="p">)</span> <span class="mi">25000</span><span class="p">)</span>
<span class="p">(</span><span class="nf">supervisor</span> <span class="p">(</span><span class="nf">Aull</span> <span class="nv">DeWitt</span><span class="p">)</span> <span class="p">(</span><span class="nf">Warbucks</span> <span class="nv">Oliver</span><span class="p">))</span>

<span class="p">(</span><span class="nf">can-do-job</span> <span class="p">(</span><span class="nf">computer</span> <span class="nv">wizard</span><span class="p">)</span> <span class="p">(</span><span class="nf">computer</span> <span class="nv">programmer</span><span class="p">))</span>
<span class="p">(</span><span class="nf">can-do-job</span> <span class="p">(</span><span class="nf">computer</span> <span class="nv">wizard</span><span class="p">)</span> <span class="p">(</span><span class="nf">computer</span> <span class="nv">technician</span><span class="p">))</span>

<span class="p">(</span><span class="nf">can-do-job</span> <span class="p">(</span><span class="nf">computer</span> <span class="nv">programmer</span><span class="p">)</span>
            <span class="p">(</span><span class="nf">computer</span> <span class="nv">programmer</span> <span class="nv">trainee</span><span class="p">))</span>

<span class="p">(</span><span class="nf">can-do-job</span> <span class="p">(</span><span class="nf">administration</span> <span class="nv">secretary</span><span class="p">)</span>
            <span class="p">(</span><span class="nf">administration</span> <span class="nv">big</span> <span class="nv">wheel</span><span class="p">))</span>

<span class="p">(</span><span class="nf">rule</span> <span class="p">(</span><span class="nf">lives-near</span> <span class="nv">?person-1</span> <span class="nv">?person-2</span><span class="p">)</span>
      <span class="p">(</span><span class="k">and</span> <span class="p">(</span><span class="nf">address</span> <span class="nv">?person-1</span> <span class="p">(</span><span class="nf">?town</span> <span class="o">.</span> <span class="nv">?rest-1</span><span class="p">))</span>
           <span class="p">(</span><span class="nf">address</span> <span class="nv">?person-2</span> <span class="p">(</span><span class="nf">?town</span> <span class="o">.</span> <span class="nv">?rest-2</span><span class="p">))</span>
           <span class="p">(</span><span class="nb">not</span> <span class="p">(</span><span class="nf">same</span> <span class="nv">?person-1</span> <span class="nv">?person-2</span><span class="p">))))</span>

<span class="p">(</span><span class="nf">rule</span> <span class="p">(</span><span class="nf">same</span> <span class="nv">?x</span> <span class="nv">?x</span><span class="p">))</span>

<span class="p">(</span><span class="nf">rule</span> <span class="p">(</span><span class="nf">wheel</span> <span class="nv">?person</span><span class="p">)</span>
      <span class="p">(</span><span class="k">and</span> <span class="p">(</span><span class="nf">supervisor</span> <span class="nv">?middle-manager</span> <span class="nv">?person</span><span class="p">)</span>
           <span class="p">(</span><span class="nf">supervisor</span> <span class="nv">?x</span> <span class="nv">?middle-manager</span><span class="p">)))</span>

<span class="p">(</span><span class="nf">rule</span> <span class="p">(</span><span class="nf">outranked-by</span> <span class="nv">?staff-person</span> <span class="nv">?boss</span><span class="p">)</span>
      <span class="p">(</span><span class="k">or</span> <span class="p">(</span><span class="nf">supervisor</span> <span class="nv">?staff-person</span> <span class="nv">?boss</span><span class="p">)</span>
          <span class="p">(</span><span class="k">and</span> <span class="p">(</span><span class="nf">supervisor</span> <span class="nv">?staff-person</span> <span class="nv">?middle-manager</span><span class="p">)</span>
               <span class="p">(</span><span class="nf">outranked-by</span> <span class="nv">?middle-manager</span> <span class="nv">?boss</span><span class="p">))))</span>
<span class="p">))</span></pre></td></tr></tbody></table></code></pre></figure>

<h3 id="complete-code-of-non-deterministic-evaluator">Complete code of non-deterministic evaluator</h3>

<figure class="highlight"><pre><code class="language-scheme" data-lang="scheme"><table class="rouge-table"><tbody><tr><td class="gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309
310
311
312
313
314
315
316
317
318
319
320
321
322
323
324
325
326
327
328
329
330
331
332
333
334
335
336
337
338
339
340
341
342
343
344
345
346
347
348
349
350
351
352
353
354
355
356
357
358
359
360
361
362
363
364
365
366
367
368
369
370
371
372
373
374
375
376
377
378
379
380
381
382
383
384
385
386
387
388
389
390
391
392
393
394
395
396
397
398
399
400
401
402
403
404
405
406
407
408
409
410
411
412
413
414
415
416
417
418
419
420
421
422
423
424
425
426
427
428
429
430
431
432
433
434
435
436
437
438
439
440
441
442
443
444
445
446
447
448
449
450
451
452
453
454
455
456
457
458
</pre></td><td class="code"><pre><span class="c1">;;;;AMB EVALUATOR FROM SECTION 4.3 OF</span>
<span class="c1">;;;; STRUCTURE AND INTERPRETATION OF COMPUTER PROGRAMS</span>

<span class="c1">;;;;Matches code in ch4.scm.</span>
<span class="c1">;;;; To run the sample programs and exercises, code below also includes</span>
<span class="c1">;;;; -- enlarged primitive-procedures list</span>
<span class="c1">;;;; -- support for Let (as noted in footnote 56, p.428)</span>

<span class="c1">;;;;This file can be loaded into Scheme as a whole.</span>
<span class="c1">;;;;**NOTE**This file loads the metacircular evaluator of</span>
<span class="c1">;;;;  sections 4.1.1-4.1.4, since it uses the expression representation,</span>
<span class="c1">;;;;  environment representation, etc.</span>
<span class="c1">;;;;  You may need to change the (load ...) expression to work in your</span>
<span class="c1">;;;;  version of Scheme.</span>
<span class="c1">;;;;**WARNING: Don't load mceval twice (or you'll lose the primitives</span>
<span class="c1">;;;;  interface, due to renamings of apply).</span>

<span class="c1">;;;; resetting the environment so that we can reload the file</span>
<span class="p">(</span><span class="nf">ge</span> <span class="p">(</span><span class="nf">make-top-level-environment</span><span class="p">))</span>
<span class="p">(</span><span class="nf">restart</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1">;;;;Then you can initialize and start the evaluator by evaluating</span>
<span class="c1">;;;; the two lines at the end of the file ch4-mceval.scm</span>
<span class="c1">;;;; (setting up the global environment and starting the driver loop).</span>
<span class="c1">;;;;In the driver loop, do</span>
<span class="c1">;(define (require p)</span>
<span class="c1">;  (if (not p) (amb)))</span>


<span class="c1">;;**implementation-dependent loading of evaluator file</span>
<span class="c1">;;Note: It is loaded first so that the section 4.2 definition</span>
<span class="c1">;; of eval overrides the definition from 4.1.1</span>
<span class="p">(</span><span class="nb">load</span> <span class="s">"ch4-mceval.scm"</span><span class="p">)</span>



<span class="c1">;;;Code from SECTION 4.3.3, modified as needed to run it</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">amb?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nf">tagged-list?</span> <span class="nv">exp</span> <span class="ss">'amb</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">ramb?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nf">tagged-list?</span> <span class="nv">exp</span> <span class="ss">'ramb</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">amb-choices</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">exp</span><span class="p">))</span>

<span class="c1">;; analyze from 4.1.6, with clause from 4.3.3 added</span>
<span class="c1">;; and also support for Let</span>
<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">analyze</span> <span class="nv">exp</span><span class="p">)</span>
  <span class="p">(</span><span class="k">cond</span> <span class="p">((</span><span class="nf">self-evaluating?</span> <span class="nv">exp</span><span class="p">)</span> 
         <span class="p">(</span><span class="nf">analyze-self-evaluating</span> <span class="nv">exp</span><span class="p">))</span>
        <span class="p">((</span><span class="nf">quoted?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nf">analyze-quoted</span> <span class="nv">exp</span><span class="p">))</span>
        <span class="p">((</span><span class="nf">variable?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nf">analyze-variable</span> <span class="nv">exp</span><span class="p">))</span>
        <span class="p">((</span><span class="nf">assignment?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nf">analyze-assignment</span> <span class="nv">exp</span><span class="p">))</span>
        <span class="p">((</span><span class="nf">pair-assign-car?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nf">analyze-pair-assign</span> <span class="nv">exp</span> <span class="nv">car</span> <span class="nv">set-car!</span><span class="p">))</span>
        <span class="p">((</span><span class="nf">pair-assign-cdr?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nf">analyze-pair-assign</span> <span class="nv">exp</span> <span class="nv">cdr</span> <span class="nv">set-cdr!</span><span class="p">))</span>
        <span class="p">((</span><span class="nf">permanent-assignment?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nf">analyze-permanent-assignment</span> <span class="nv">exp</span><span class="p">))</span>
        <span class="p">((</span><span class="nf">definition?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nf">analyze-definition</span> <span class="nv">exp</span><span class="p">))</span>
        <span class="p">((</span><span class="nf">if?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nf">analyze-if</span> <span class="nv">exp</span><span class="p">))</span>
        <span class="p">((</span><span class="nf">if-fail?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nf">analyze-if-fail</span> <span class="nv">exp</span><span class="p">))</span>
        <span class="p">((</span><span class="nf">ensure-fail?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nf">analyze-ensure-fail</span> <span class="nv">exp</span><span class="p">))</span>
        <span class="p">((</span><span class="nf">lambda?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nf">analyze-lambda</span> <span class="nv">exp</span><span class="p">))</span>
        <span class="p">((</span><span class="nf">begin?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nf">analyze-sequence</span> <span class="p">(</span><span class="nf">begin-actions</span> <span class="nv">exp</span><span class="p">)))</span>
        <span class="p">((</span><span class="nf">cond?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nf">analyze</span> <span class="p">(</span><span class="nf">cond-&gt;if</span> <span class="nv">exp</span><span class="p">)))</span>
        <span class="p">((</span><span class="nf">let?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nf">analyze</span> <span class="p">(</span><span class="nf">let-&gt;combination</span> <span class="nv">exp</span><span class="p">)))</span> <span class="c1">;**</span>
        <span class="p">((</span><span class="nf">amb?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nf">analyze-amb</span> <span class="nv">exp</span><span class="p">))</span>                <span class="c1">;**</span>
        <span class="p">((</span><span class="nf">ramb?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nf">analyze-ramb</span> <span class="nv">exp</span><span class="p">))</span>                <span class="c1">;**</span>
        <span class="p">((</span><span class="nf">require?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nf">analyze-require</span> <span class="nv">exp</span><span class="p">))</span>                <span class="c1">;**</span>
        <span class="p">((</span><span class="nf">application?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nf">analyze-application</span> <span class="nv">exp</span><span class="p">))</span>
        <span class="p">(</span><span class="k">else</span>
         <span class="p">(</span><span class="nf">error</span> <span class="s">"Unknown expression type -- ANALYZE"</span> <span class="nv">exp</span><span class="p">))))</span>
<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">require?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nf">tagged-list?</span> <span class="nv">exp</span> <span class="ss">'require</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">require-predicate</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nb">cadr</span> <span class="nv">exp</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">analyze-require</span> <span class="nv">exp</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">pproc</span> <span class="p">(</span><span class="nf">analyze</span> <span class="p">(</span><span class="nf">require-predicate</span> <span class="nv">exp</span><span class="p">))))</span>
    <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">env</span> <span class="nv">succeed</span> <span class="nv">fail</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">pproc</span> <span class="nv">env</span>
             <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">pred-value</span> <span class="nv">fail2</span><span class="p">)</span>
               <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">not</span> <span class="p">(</span><span class="nf">true?</span> <span class="nv">pred-value</span><span class="p">))</span>
                   <span class="p">(</span><span class="nf">fail2</span><span class="p">)</span>
                   <span class="p">(</span><span class="nf">succeed</span> <span class="ss">'ok</span> <span class="nv">fail2</span><span class="p">)))</span>
             <span class="nv">fail</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">ambeval</span> <span class="nv">exp</span> <span class="nv">env</span> <span class="nv">succeed</span> <span class="nv">fail</span><span class="p">)</span>
  <span class="p">((</span><span class="nf">analyze</span> <span class="nv">exp</span><span class="p">)</span> <span class="nv">env</span> <span class="nv">succeed</span> <span class="nv">fail</span><span class="p">))</span>

<span class="c1">;;;Simple expressions</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">analyze-self-evaluating</span> <span class="nv">exp</span><span class="p">)</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">env</span> <span class="nv">succeed</span> <span class="nv">fail</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">succeed</span> <span class="nv">exp</span> <span class="nv">fail</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">analyze-quoted</span> <span class="nv">exp</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">qval</span> <span class="p">(</span><span class="nf">text-of-quotation</span> <span class="nv">exp</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">env</span> <span class="nv">succeed</span> <span class="nv">fail</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">succeed</span> <span class="nv">qval</span> <span class="nv">fail</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">analyze-variable</span> <span class="nv">exp</span><span class="p">)</span>
  <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">env</span> <span class="nv">succeed</span> <span class="nv">fail</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">succeed</span> <span class="p">(</span><span class="nf">lookup-variable-value</span> <span class="nv">exp</span> <span class="nv">env</span><span class="p">)</span>
             <span class="nv">fail</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">analyze-lambda</span> <span class="nv">exp</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">vars</span> <span class="p">(</span><span class="nf">lambda-parameters</span> <span class="nv">exp</span><span class="p">))</span>
        <span class="p">(</span><span class="nf">bproc</span> <span class="p">(</span><span class="nf">analyze-sequence</span> <span class="p">(</span><span class="nf">lambda-body</span> <span class="nv">exp</span><span class="p">))))</span>
    <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">env</span> <span class="nv">succeed</span> <span class="nv">fail</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">succeed</span> <span class="p">(</span><span class="nf">make-procedure</span> <span class="nv">vars</span> <span class="nv">bproc</span> <span class="nv">env</span><span class="p">)</span>
               <span class="nv">fail</span><span class="p">))))</span>

<span class="c1">;;;Conditionals and sequences</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">ensure-fail?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nf">tagged-list?</span> <span class="nv">exp</span> <span class="ss">'ensure-fail</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">ensure-fail-expression</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nb">cadr</span> <span class="nv">exp</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">analyze-ensure-fail</span> <span class="nv">exp</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">expr</span> <span class="p">(</span><span class="nf">analyze</span> <span class="p">(</span><span class="nf">ensure-fail-expression</span> <span class="nv">exp</span><span class="p">))))</span>
	<span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">env</span> <span class="nv">succeed</span> <span class="nv">fail</span><span class="p">)</span>
	  <span class="p">(</span><span class="nf">expr</span> <span class="nv">env</span>
			  <span class="p">(</span><span class="k">lambda</span><span class="p">(</span><span class="nf">ignore</span> <span class="nv">fail2</span><span class="p">)</span> <span class="p">(</span><span class="nf">fail</span><span class="p">))</span>
			  <span class="p">(</span><span class="k">lambda</span><span class="p">()</span> <span class="p">(</span><span class="nf">succeed</span> <span class="ss">'ok</span> <span class="nv">fail</span><span class="p">))))))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">if-fail?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nf">tagged-list?</span> <span class="nv">exp</span> <span class="ss">'if-fail</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">if-fail-first</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nb">cadr</span> <span class="nv">exp</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">if-fail-second</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nb">caddr</span> <span class="nv">exp</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">analyze-if-fail</span> <span class="nv">exp</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">first</span> <span class="p">(</span><span class="nf">analyze</span> <span class="p">(</span><span class="nf">if-fail-first</span> <span class="nv">exp</span><span class="p">)))</span>
		<span class="p">(</span><span class="nf">second</span> <span class="p">(</span><span class="nf">analyze</span> <span class="p">(</span><span class="nf">if-fail-second</span> <span class="nv">exp</span><span class="p">))))</span>
	<span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">env</span> <span class="nv">succeed</span> <span class="nv">fail</span><span class="p">)</span>
	  <span class="p">(</span><span class="nf">first</span> <span class="nv">env</span>
			  <span class="nv">succeed</span>
			 <span class="p">(</span><span class="k">lambda</span><span class="p">()</span>
			   <span class="p">(</span><span class="nf">second</span> <span class="nv">env</span> <span class="nv">succeed</span> <span class="nv">fail</span><span class="p">))))))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">analyze-if</span> <span class="nv">exp</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">pproc</span> <span class="p">(</span><span class="nf">analyze</span> <span class="p">(</span><span class="nf">if-predicate</span> <span class="nv">exp</span><span class="p">)))</span>
        <span class="p">(</span><span class="nf">cproc</span> <span class="p">(</span><span class="nf">analyze</span> <span class="p">(</span><span class="nf">if-consequent</span> <span class="nv">exp</span><span class="p">)))</span>
        <span class="p">(</span><span class="nf">aproc</span> <span class="p">(</span><span class="nf">analyze</span> <span class="p">(</span><span class="nf">if-alternative</span> <span class="nv">exp</span><span class="p">))))</span>
    <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">env</span> <span class="nv">succeed</span> <span class="nv">fail</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">pproc</span> <span class="nv">env</span>
             <span class="c1">;; success continuation for evaluating the predicate</span>
             <span class="c1">;; to obtain pred-value</span>
             <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">pred-value</span> <span class="nv">fail2</span><span class="p">)</span>
               <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nf">true?</span> <span class="nv">pred-value</span><span class="p">)</span>
                   <span class="p">(</span><span class="nf">cproc</span> <span class="nv">env</span> <span class="nv">succeed</span> <span class="nv">fail2</span><span class="p">)</span>
                   <span class="p">(</span><span class="nf">aproc</span> <span class="nv">env</span> <span class="nv">succeed</span> <span class="nv">fail2</span><span class="p">)))</span>
             <span class="c1">;; failure continuation for evaluating the predicate</span>
             <span class="nv">fail</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">analyze-sequence</span> <span class="nv">exps</span><span class="p">)</span>
  <span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">sequentially</span> <span class="nv">a</span> <span class="nv">b</span><span class="p">)</span>
    <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">env</span> <span class="nv">succeed</span> <span class="nv">fail</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">a</span> <span class="nv">env</span>
         <span class="c1">;; success continuation for calling a</span>
         <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">a-value</span> <span class="nv">fail2</span><span class="p">)</span>
           <span class="p">(</span><span class="nf">b</span> <span class="nv">env</span> <span class="nv">succeed</span> <span class="nv">fail2</span><span class="p">))</span>
         <span class="c1">;; failure continuation for calling a</span>
         <span class="nv">fail</span><span class="p">)))</span>
  <span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">loop</span> <span class="nv">first-proc</span> <span class="nv">rest-procs</span><span class="p">)</span>
    <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">null?</span> <span class="nv">rest-procs</span><span class="p">)</span>
        <span class="nv">first-proc</span>
        <span class="p">(</span><span class="nf">loop</span> <span class="p">(</span><span class="nf">sequentially</span> <span class="nv">first-proc</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">rest-procs</span><span class="p">))</span>
              <span class="p">(</span><span class="nb">cdr</span> <span class="nv">rest-procs</span><span class="p">))))</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">procs</span> <span class="p">(</span><span class="nb">map</span> <span class="nv">analyze</span> <span class="nv">exps</span><span class="p">)))</span>
    <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">null?</span> <span class="nv">procs</span><span class="p">)</span>
        <span class="p">(</span><span class="nf">error</span> <span class="s">"Empty sequence -- ANALYZE"</span><span class="p">))</span>
    <span class="p">(</span><span class="nf">loop</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">procs</span><span class="p">)</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">procs</span><span class="p">))))</span>

<span class="c1">;;;Definitions and assignments</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">analyze-definition</span> <span class="nv">exp</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">var</span> <span class="p">(</span><span class="nf">definition-variable</span> <span class="nv">exp</span><span class="p">))</span>
        <span class="p">(</span><span class="nf">vproc</span> <span class="p">(</span><span class="nf">analyze</span> <span class="p">(</span><span class="nf">definition-value</span> <span class="nv">exp</span><span class="p">))))</span>
    <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">env</span> <span class="nv">succeed</span> <span class="nv">fail</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">vproc</span> <span class="nv">env</span>                        
             <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">val</span> <span class="nv">fail2</span><span class="p">)</span>
               <span class="p">(</span><span class="nf">define-variable!</span> <span class="nv">var</span> <span class="nv">val</span> <span class="nv">env</span><span class="p">)</span>
               <span class="p">(</span><span class="nf">succeed</span> <span class="ss">'ok</span> <span class="nv">fail2</span><span class="p">))</span>
             <span class="nv">fail</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">analyze-assignment</span> <span class="nv">exp</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">var</span> <span class="p">(</span><span class="nf">assignment-variable</span> <span class="nv">exp</span><span class="p">))</span>
        <span class="p">(</span><span class="nf">vproc</span> <span class="p">(</span><span class="nf">analyze</span> <span class="p">(</span><span class="nf">assignment-value</span> <span class="nv">exp</span><span class="p">))))</span>
    <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">env</span> <span class="nv">succeed</span> <span class="nv">fail</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">vproc</span> <span class="nv">env</span>
             <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">val</span> <span class="nv">fail2</span><span class="p">)</span>        <span class="c1">; *1*</span>
               <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">old-value</span>
                      <span class="p">(</span><span class="nf">lookup-variable-value</span> <span class="nv">var</span> <span class="nv">env</span><span class="p">)))</span> 
                 <span class="p">(</span><span class="nf">set-variable-value!</span> <span class="nv">var</span> <span class="nv">val</span> <span class="nv">env</span><span class="p">)</span>
                 <span class="p">(</span><span class="nf">succeed</span> <span class="ss">'ok</span>
                          <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span>    <span class="c1">; *2*</span>
                            <span class="p">(</span><span class="nf">set-variable-value!</span> <span class="nv">var</span>
                                                 <span class="nv">old-value</span>
                                                 <span class="nv">env</span><span class="p">)</span>
                            <span class="p">(</span><span class="nf">fail2</span><span class="p">)))))</span>
             <span class="nv">fail</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">permanent-assignment?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nf">tagged-list?</span> <span class="nv">exp</span> <span class="ss">'permanent-set!</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">analyze-permanent-assignment</span> <span class="nv">exp</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">var</span> <span class="p">(</span><span class="nf">assignment-variable</span> <span class="nv">exp</span><span class="p">))</span>
        <span class="p">(</span><span class="nf">vproc</span> <span class="p">(</span><span class="nf">analyze</span> <span class="p">(</span><span class="nf">assignment-value</span> <span class="nv">exp</span><span class="p">))))</span>
    <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">env</span> <span class="nv">succeed</span> <span class="nv">fail</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">vproc</span> <span class="nv">env</span>
             <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">val</span> <span class="nv">fail2</span><span class="p">)</span>        <span class="c1">; *1*</span>
               <span class="p">(</span><span class="nf">set-variable-value!</span> <span class="nv">var</span> <span class="nv">val</span> <span class="nv">env</span><span class="p">)</span>
               <span class="p">(</span><span class="nf">succeed</span> <span class="ss">'ok</span> <span class="nv">fail2</span><span class="p">))</span>
			 <span class="nv">fail</span><span class="p">))))</span>

<span class="c1">;;;set-car! and set-cdr!</span>
<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">pair-assign-car?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nf">tagged-list?</span> <span class="nv">exp</span> <span class="ss">'set-car!</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">pair-assign-cdr?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nf">tagged-list?</span> <span class="nv">exp</span> <span class="ss">'set-cdr!</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">pair-assign-expression</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nb">cadr</span> <span class="nv">exp</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">pair-assign-value</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nb">caddr</span> <span class="nv">exp</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">analyze-pair-assign</span> <span class="nv">exp</span> <span class="nv">selector</span> <span class="nv">mutator!</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">eproc</span> <span class="p">(</span><span class="nf">analyze</span> <span class="p">(</span><span class="nf">pair-assign-expression</span> <span class="nv">exp</span><span class="p">)))</span>
        <span class="p">(</span><span class="nf">vproc</span> <span class="p">(</span><span class="nf">analyze</span> <span class="p">(</span><span class="nf">pair-assign-value</span> <span class="nv">exp</span><span class="p">))))</span>
    <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">env</span> <span class="nv">succeed</span> <span class="nv">fail</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">eproc</span> <span class="nv">env</span>
             <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">expr</span> <span class="nv">fail2</span><span class="p">)</span>
			   <span class="p">(</span><span class="nf">vproc</span> <span class="nv">env</span>
					  <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">val</span> <span class="nv">fail3</span><span class="p">)</span>
						<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">old-value</span> <span class="p">(</span><span class="nf">selector</span> <span class="nv">expr</span><span class="p">)))</span>
						  <span class="p">(</span><span class="nf">mutator!</span> <span class="nv">expr</span> <span class="nv">val</span><span class="p">)</span>
						  <span class="p">(</span><span class="nf">succeed</span> <span class="ss">'ok</span>
								   <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span>    
									 <span class="p">(</span><span class="nf">mutator!</span> <span class="nv">expr</span>
											   <span class="nv">old-value</span><span class="p">)</span>
									 <span class="p">(</span><span class="nf">fail3</span><span class="p">)))))</span>
					  <span class="nv">fail2</span><span class="p">))</span>
             <span class="nv">fail</span><span class="p">))))</span>

<span class="c1">;;;Procedure applications</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">analyze-application</span> <span class="nv">exp</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">fproc</span> <span class="p">(</span><span class="nf">analyze</span> <span class="p">(</span><span class="nf">operator</span> <span class="nv">exp</span><span class="p">)))</span>
        <span class="p">(</span><span class="nf">aprocs</span> <span class="p">(</span><span class="nb">map</span> <span class="nv">analyze</span> <span class="p">(</span><span class="nf">operands</span> <span class="nv">exp</span><span class="p">))))</span>
    <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">env</span> <span class="nv">succeed</span> <span class="nv">fail</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">fproc</span> <span class="nv">env</span>
             <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">proc</span> <span class="nv">fail2</span><span class="p">)</span>
               <span class="p">(</span><span class="nf">get-args</span> <span class="nv">aprocs</span>
                         <span class="nv">env</span>
                         <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">args</span> <span class="nv">fail3</span><span class="p">)</span>
                           <span class="p">(</span><span class="nf">execute-application</span>
                            <span class="nv">proc</span> <span class="nv">args</span> <span class="nv">succeed</span> <span class="nv">fail3</span><span class="p">))</span>
                         <span class="nv">fail2</span><span class="p">))</span>
             <span class="nv">fail</span><span class="p">))))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">get-args</span> <span class="nv">aprocs</span> <span class="nv">env</span> <span class="nv">succeed</span> <span class="nv">fail</span><span class="p">)</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">null?</span> <span class="nv">aprocs</span><span class="p">)</span>
      <span class="p">(</span><span class="nf">succeed</span> <span class="o">'</span><span class="p">()</span> <span class="nv">fail</span><span class="p">)</span>
      <span class="p">((</span><span class="nb">car</span> <span class="nv">aprocs</span><span class="p">)</span> <span class="nv">env</span>
                    <span class="c1">;; success continuation for this aproc</span>
                    <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">arg</span> <span class="nv">fail2</span><span class="p">)</span>
                      <span class="p">(</span><span class="nf">get-args</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">aprocs</span><span class="p">)</span>
                                <span class="nv">env</span>
                                <span class="c1">;; success continuation for recursive</span>
                                <span class="c1">;; call to get-args</span>
                                <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">args</span> <span class="nv">fail3</span><span class="p">)</span>
                                  <span class="p">(</span><span class="nf">succeed</span> <span class="p">(</span><span class="nb">cons</span> <span class="nv">arg</span> <span class="nv">args</span><span class="p">)</span>
                                           <span class="nv">fail3</span><span class="p">))</span>
                                <span class="nv">fail2</span><span class="p">))</span>
                    <span class="nv">fail</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">execute-application</span> <span class="nv">proc</span> <span class="nv">args</span> <span class="nv">succeed</span> <span class="nv">fail</span><span class="p">)</span>
  <span class="p">(</span><span class="k">cond</span> <span class="p">((</span><span class="nf">primitive-procedure?</span> <span class="nv">proc</span><span class="p">)</span>
         <span class="p">(</span><span class="nf">succeed</span> <span class="p">(</span><span class="nf">apply-primitive-procedure</span> <span class="nv">proc</span> <span class="nv">args</span><span class="p">)</span>
                  <span class="nv">fail</span><span class="p">))</span>
        <span class="p">((</span><span class="nf">compound-procedure?</span> <span class="nv">proc</span><span class="p">)</span>
         <span class="p">((</span><span class="nf">procedure-body</span> <span class="nv">proc</span><span class="p">)</span>
          <span class="p">(</span><span class="nf">extend-environment</span> <span class="p">(</span><span class="nf">procedure-parameters</span> <span class="nv">proc</span><span class="p">)</span>
                              <span class="nv">args</span>
                              <span class="p">(</span><span class="nf">procedure-environment</span> <span class="nv">proc</span><span class="p">))</span>
          <span class="nv">succeed</span>
          <span class="nv">fail</span><span class="p">))</span>
        <span class="p">(</span><span class="k">else</span>
         <span class="p">(</span><span class="nf">error</span>
          <span class="s">"Unknown procedure type -- EXECUTE-APPLICATION"</span>
          <span class="nv">proc</span><span class="p">))))</span>

<span class="c1">;;;amb expressions</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">list-cons-ref</span> <span class="nv">l</span> <span class="nv">index</span><span class="p">)</span>
  <span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">iter</span> <span class="nv">l</span> <span class="nv">index</span><span class="p">)</span>
	<span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">=</span> <span class="nv">index</span> <span class="mi">0</span><span class="p">)</span>
		<span class="nv">l</span>
		<span class="p">(</span><span class="nf">iter</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">l</span><span class="p">)</span> <span class="p">(</span><span class="nb">-</span> <span class="nv">index</span> <span class="mi">1</span><span class="p">))))</span>
  
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">&lt;</span> <span class="nv">index</span> <span class="mi">0</span><span class="p">)</span>
	  <span class="p">(</span><span class="nf">error</span> <span class="s">"index can not be negative!"</span><span class="p">)</span>
	  <span class="p">(</span><span class="nf">iter</span> <span class="nv">l</span> <span class="nv">index</span><span class="p">)))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">move-random-to-first!</span> <span class="nv">l</span> <span class="nv">length</span><span class="p">)</span>
  <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">&lt;=</span> <span class="nv">length</span> <span class="mi">1</span><span class="p">)</span>
	  <span class="nv">l</span>
	  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">random-index</span> <span class="p">(</span><span class="nf">random</span> <span class="nv">length</span><span class="p">))</span>
			<span class="p">(</span><span class="nf">first-elem</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">l</span><span class="p">)))</span>
		<span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nb">list-ref</span> <span class="p">(</span><span class="nf">list-cons-ref</span> <span class="nv">l</span> <span class="nv">random-index</span><span class="p">)))</span>
		  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">random-elem</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">list-ref</span><span class="p">)))</span>
			<span class="p">(</span><span class="nb">set-car!</span> <span class="nv">l</span> <span class="nv">random-elem</span><span class="p">)</span>
			<span class="p">(</span><span class="nb">set-car!</span> <span class="nv">list-ref</span> <span class="nv">first-elem</span><span class="p">))))))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">analyze-ramb</span> <span class="nv">exp</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">cprocs</span> <span class="p">(</span><span class="nb">map</span> <span class="nv">analyze</span> <span class="p">(</span><span class="nf">amb-choices</span> <span class="nv">exp</span><span class="p">))))</span>
    <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">env</span> <span class="nv">succeed</span> <span class="nv">fail</span><span class="p">)</span>
	  <span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">try-next</span> <span class="nv">choices</span> <span class="nv">length</span><span class="p">)</span>
        <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">null?</span> <span class="nv">choices</span><span class="p">)</span>
            <span class="p">(</span><span class="nf">fail</span><span class="p">)</span>
			<span class="p">(</span><span class="k">begin</span>
			  <span class="p">(</span><span class="nf">move-random-to-first!</span> <span class="nv">choices</span> <span class="nv">length</span><span class="p">)</span>
			  <span class="p">((</span><span class="nb">car</span> <span class="nv">choices</span><span class="p">)</span>
			   <span class="nv">env</span>
               <span class="nv">succeed</span>
               <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span>
                 <span class="p">(</span><span class="nf">try-next</span>
				  <span class="p">(</span><span class="nb">cdr</span> <span class="nv">choices</span><span class="p">)</span>
				  <span class="p">(</span><span class="nb">-</span> <span class="nv">length</span> <span class="mi">1</span><span class="p">)))))))</span>
	  <span class="p">(</span><span class="nf">try-next</span> <span class="nv">cprocs</span> <span class="p">(</span><span class="nb">length</span> <span class="nv">cprocs</span><span class="p">)))))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">analyze-amb</span> <span class="nv">exp</span><span class="p">)</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">cprocs</span> <span class="p">(</span><span class="nb">map</span> <span class="nv">analyze</span> <span class="p">(</span><span class="nf">amb-choices</span> <span class="nv">exp</span><span class="p">))))</span>
    <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">env</span> <span class="nv">succeed</span> <span class="nv">fail</span><span class="p">)</span>
      <span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">try-next</span> <span class="nv">choices</span><span class="p">)</span>
        <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">null?</span> <span class="nv">choices</span><span class="p">)</span>
            <span class="p">(</span><span class="nf">fail</span><span class="p">)</span>
            <span class="p">((</span><span class="nb">car</span> <span class="nv">choices</span><span class="p">)</span> <span class="nv">env</span>
                           <span class="nv">succeed</span>
                           <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span>
                             <span class="p">(</span><span class="nf">try-next</span> <span class="p">(</span><span class="nb">cdr</span> <span class="nv">choices</span><span class="p">))))))</span>
      <span class="p">(</span><span class="nf">try-next</span> <span class="nv">cprocs</span><span class="p">))))</span>

<span class="c1">;;;Driver loop</span>

<span class="p">(</span><span class="k">define</span> <span class="nv">input-prompt</span> <span class="s">";;; Amb-Eval input:"</span><span class="p">)</span>
<span class="p">(</span><span class="k">define</span> <span class="nv">output-prompt</span> <span class="s">";;; Amb-Eval value:"</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">driver-loop</span><span class="p">)</span>
  <span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">internal-loop</span> <span class="nv">try-again</span><span class="p">)</span>
    <span class="p">(</span><span class="nf">prompt-for-input</span> <span class="nv">input-prompt</span><span class="p">)</span>
    <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">input</span> <span class="p">(</span><span class="nb">read</span><span class="p">)))</span>
	  <span class="p">(</span><span class="k">define</span> <span class="nv">stime</span> <span class="p">(</span><span class="nf">get-universal-time</span><span class="p">))</span>
      <span class="p">(</span><span class="k">if</span> <span class="p">(</span><span class="nb">eq?</span> <span class="nv">input</span> <span class="ss">'try-again</span><span class="p">)</span>
          <span class="p">(</span><span class="nf">try-again</span><span class="p">)</span>
          <span class="p">(</span><span class="k">begin</span>
            <span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
            <span class="p">(</span><span class="nb">display</span> <span class="s">";;; Starting a new problem "</span><span class="p">)</span>
            <span class="p">(</span><span class="nf">ambeval</span> <span class="nv">input</span>
                     <span class="nv">the-global-environment</span>
                     <span class="c1">;; ambeval success</span>
                     <span class="p">(</span><span class="k">lambda</span> <span class="p">(</span><span class="nf">val</span> <span class="nv">next-alternative</span><span class="p">)</span>
					   <span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
                       <span class="p">(</span><span class="nf">announce-output</span> <span class="nv">output-prompt</span><span class="p">)</span>
                       <span class="p">(</span><span class="nf">user-print</span> <span class="nv">val</span><span class="p">)</span>
                       <span class="p">(</span><span class="nf">internal-loop</span> <span class="nv">next-alternative</span><span class="p">))</span>
                     <span class="c1">;; ambeval failure</span>
                     <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span>
                       <span class="p">(</span><span class="nf">announce-output</span>
                        <span class="s">";;; There are no more values of"</span><span class="p">)</span>
                       <span class="p">(</span><span class="nf">user-print</span> <span class="nv">input</span><span class="p">)</span>
                       <span class="p">(</span><span class="nf">driver-loop</span><span class="p">)))))))</span>
  <span class="p">(</span><span class="nf">internal-loop</span>
   <span class="p">(</span><span class="k">lambda</span> <span class="p">()</span>
     <span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
     <span class="p">(</span><span class="nb">display</span> <span class="s">";;; There is no current problem"</span><span class="p">)</span>
     <span class="p">(</span><span class="nf">driver-loop</span><span class="p">))))</span>



<span class="c1">;;; Support for Let (as noted in footnote 56, p.428)</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">let?</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nf">tagged-list?</span> <span class="nv">exp</span> <span class="ss">'let</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">let-bindings</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nb">cadr</span> <span class="nv">exp</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">let-body</span> <span class="nv">exp</span><span class="p">)</span> <span class="p">(</span><span class="nb">cddr</span> <span class="nv">exp</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">let-var</span> <span class="nv">binding</span><span class="p">)</span> <span class="p">(</span><span class="nb">car</span> <span class="nv">binding</span><span class="p">))</span>
<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">let-val</span> <span class="nv">binding</span><span class="p">)</span> <span class="p">(</span><span class="nb">cadr</span> <span class="nv">binding</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">make-combination</span> <span class="nv">operator</span> <span class="nv">operands</span><span class="p">)</span> <span class="p">(</span><span class="nb">cons</span> <span class="nv">operator</span> <span class="nv">operands</span><span class="p">))</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">let-&gt;combination</span> <span class="nv">exp</span><span class="p">)</span>
  <span class="c1">;;make-combination defined in earlier exercise</span>
  <span class="p">(</span><span class="k">let</span> <span class="p">((</span><span class="nf">bindings</span> <span class="p">(</span><span class="nf">let-bindings</span> <span class="nv">exp</span><span class="p">)))</span>
    <span class="p">(</span><span class="nf">make-combination</span> <span class="p">(</span><span class="nf">make-lambda</span> <span class="p">(</span><span class="nb">map</span> <span class="nv">let-var</span> <span class="nv">bindings</span><span class="p">)</span>
                                   <span class="p">(</span><span class="nf">let-body</span> <span class="nv">exp</span><span class="p">))</span>
                      <span class="p">(</span><span class="nb">map</span> <span class="nv">let-val</span> <span class="nv">bindings</span><span class="p">))))</span>
                     


<span class="c1">;; A longer list of primitives -- suitable for running everything in 4.3</span>
<span class="c1">;; Overrides the list in ch4-mceval.scm</span>
<span class="c1">;; Has Not to support Require; various stuff for code in text (including</span>
<span class="c1">;;  support for Prime?); integer? and sqrt for exercise code;</span>
<span class="c1">;;  eq? for ex. solution</span>

<span class="c1">;;primitive display can not be used as primitive procedure</span>
<span class="c1">;; because evaluator assumes that return every procedure</span>
<span class="c1">;; returns a value</span>
<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">display-items</span> <span class="o">.</span> <span class="nv">items</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">newline</span><span class="p">)</span>
  <span class="p">(</span><span class="nb">display</span> <span class="nv">items</span><span class="p">)</span>
  <span class="ss">'ok</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span> <span class="p">(</span><span class="nf">error-items</span> <span class="o">.</span> <span class="nv">items</span><span class="p">)</span>
  <span class="p">(</span><span class="nf">error</span> <span class="nv">items</span><span class="p">)</span>
  <span class="ss">'ok</span><span class="p">)</span>

<span class="p">(</span><span class="k">define</span> <span class="nv">primitive-procedures</span>
  <span class="p">(</span><span class="nb">list</span> <span class="p">(</span><span class="nb">list</span> <span class="ss">'car</span> <span class="nv">car</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'cdr</span> <span class="nv">cdr</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'cons</span> <span class="nv">cons</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'null?</span> <span class="nv">null?</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'list</span> <span class="nv">list</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'memq</span> <span class="nv">memq</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'member</span> <span class="nv">member</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'map</span> <span class="nv">map</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'not</span> <span class="nv">not</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'+</span> <span class="nv">+</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'-</span> <span class="nv">-</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'*</span> <span class="nv">*</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'=</span> <span class="nv">=</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'&gt;</span> <span class="nv">&gt;</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'&lt;</span> <span class="nv">&lt;</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'&gt;=</span> <span class="nv">&gt;=</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'&lt;=</span> <span class="nv">&lt;=</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'abs</span> <span class="nv">abs</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'remainder</span> <span class="nv">remainder</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'integer?</span> <span class="nv">integer?</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'sqrt</span> <span class="nv">sqrt</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'eq?</span> <span class="nv">eq?</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'equal?</span> <span class="nv">equal?</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'number?</span> <span class="nv">number?</span><span class="p">)</span>
		<span class="p">(</span><span class="nb">list</span> <span class="ss">'symbol?</span> <span class="nv">symbol?</span><span class="p">)</span>
		<span class="p">(</span><span class="nb">list</span> <span class="ss">'string=?</span> <span class="nv">string=?</span><span class="p">)</span>
		<span class="p">(</span><span class="nb">list</span> <span class="ss">'string-length</span> <span class="nv">string-length</span><span class="p">)</span>
		<span class="p">(</span><span class="nb">list</span> <span class="ss">'substring</span> <span class="nv">substring</span><span class="p">)</span>
		<span class="p">(</span><span class="nb">list</span> <span class="ss">'string-append</span> <span class="nv">string-append</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'string-&gt;symbol</span> <span class="nv">string-&gt;symbol</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'symbol-&gt;string</span> <span class="nv">symbol-&gt;string</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'number-&gt;string</span> <span class="nv">number-&gt;string</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'pair?</span> <span class="nv">pair?</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'cadr</span> <span class="nv">cadr</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'cdar</span> <span class="nv">cdar</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'cddr</span> <span class="nv">cddr</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'caddr</span> <span class="nv">caddr</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'assoc</span> <span class="nv">assoc</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'append</span> <span class="nv">append</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'eval</span> <span class="nv">eval</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'apply</span> <span class="nv">apply</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'display</span> <span class="nv">display-items</span><span class="p">)</span>
        <span class="p">(</span><span class="nb">list</span> <span class="ss">'error</span> <span class="nv">error-items</span><span class="p">)</span>
		
<span class="c1">;;      more primitives</span>
        <span class="p">))</span>

<span class="p">(</span><span class="k">define</span> <span class="nv">the-global-environment</span> <span class="p">(</span><span class="nf">setup-environment</span><span class="p">))</span>
<span class="p">(</span><span class="nf">driver-loop</span><span class="p">)</span>

<span class="ss">'AMB-EVALUATOR-LOADED</span></pre></td></tr></tbody></table></code></pre></figure>

<p>In the above evaluator, file “ch4-mceval.scm” is used which can be downloaded from <a href="https://mitpress.mit.edu/sites/default/files/sicp/code/ch4-mceval.scm">mit</a>. Note that, there is one change to be done in this file in <code class="highlighter-rouge">setup-environment</code> mentioned in the above details.</p>


                        <hr/>
                    </span>

                    <br/>

                    

	<div id="disqus_thread"></div>
	<script>
		/**
		 * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
		 * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
		 */
		var disqus_identifier = 'inchmeal';

		
		var disqus_config = function () {
		 //this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
		 this.page.identifier = "/sicp/ch-4/ex-4.78.html"; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
		};
		


		(function() { // DON'T EDIT BELOW THIS LINE
			var d = document, s = d.createElement('script');

			s.src = '//' + disqus_identifier + '.disqus.com/embed.js';

			s.setAttribute('data-timestamp', +new Date());
			(d.head || d.body).appendChild(s);
		})();
	</script>
	<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript>






                </article>
            </div><!-- /.small-11.columns -->
        </div><!-- /.row -->
    </div><!-- /.medium-8.columns -->
</div><!-- /.row -->


	    <div id="up-to-top" class="row">
      <div class="small-12 columns" style="text-align: right;">
        <a class="iconfont" title="Go to Top" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast')">&#xf108;</a>
      </div><!-- /.small-12.columns -->
    </div><!-- /.row -->

    <footer id="footer-content" class="bg-grau">
      <div id="subfooter">
        <nav class="row">
          <section id="subfooter-left" class="small-6 columns">
                <div class="column pl0 pr0">
                    <ul class="inline-list">
                        <li>Created with &hearts; by ovais</li>
                    </ul>
                </div>
                <div class="column pl0 pr0">
                    <ul class="inline-list">
                        
                        <li><a href="/rss-feed.xml"  target="_blank"  class="rss-link" title="Subscribe to RSS">RSS</a></li>
                        
                        <li><a href="mailto:mailovais85@gmail.com"  class="contact-link" title="Contact">Contact</a></li>
                        
                    </ul>
                </div>
              <div class="column pl0 pr0">
                  <ul class="inline-list">
                      <li>&copy;2019 inchmeal</li>
                  </ul>
              </div>
          </section>
          <section id="subfooter-right" class="small-6 columns social-icons end">
              <div class="column pl0 pr0">
              <ul class="inline-list">
                
                  <li><a href="http://twitter.com/0vai5" target="_blank" class="icon-twitter" title="Follow on twitter"></a></li>
                
                  <li><a href="http://github.com/0vais" target="_blank" class="icon-github" title="Follow on github"></a></li>
                
              </ul>
              </div>
          </section>
        </nav>
      </div><!-- /#subfooter -->
    </footer>


	<script src="https://www.inchmeal.io/assets/js/inchmeal_all.js"></script>

<script>
  var sectionName = "sicp";
  
  //google analytics
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-73233179-1', 'auto');
  ga('send', 'pageview');
  
</script>

</body>
</html>
